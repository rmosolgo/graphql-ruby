<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Class: GraphQL::Subscriptions::ActionCableSubscriptions
  
    &mdash; GraphQL Ruby API Documentation
  
</title>

  <link rel="stylesheet" href="../../css/style.css" type="text/css" />

  <link rel="stylesheet" href="../../css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "GraphQL::Subscriptions::ActionCableSubscriptions";
  relpath = '../../';
</script>


  <script type="text/javascript" charset="utf-8" src="../../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../../js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="../../class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="../../_index.html">Index (A)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../../GraphQL.html" title="GraphQL (module)">GraphQL</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../Subscriptions.html" title="GraphQL::Subscriptions (class)">Subscriptions</a></span></span>
     &raquo; 
    <span class="title">ActionCableSubscriptions</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../../class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Class: GraphQL::Subscriptions::ActionCableSubscriptions
  
  
  
</h1>
<div class="box_info">
  
  <dl>
    <dt>Inherits:</dt>
    <dd>
      <span class="inheritName"><span class='object_link'><a href="../Subscriptions.html" title="GraphQL::Subscriptions (class)">GraphQL::Subscriptions</a></span></span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next"><span class='object_link'><a href="../Subscriptions.html" title="GraphQL::Subscriptions (class)">GraphQL::Subscriptions</a></span></li>
          
            <li class="next">GraphQL::Subscriptions::ActionCableSubscriptions</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
    </dd>
  </dl>
  

  
  
  
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>lib/graphql/subscriptions/action_cable_subscriptions.rb</dd>
  </dl>
  
</div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    <p>A subscriptions implementation that sends data
as ActionCable broadcastings.</p>

<p>Some things to keep in mind:</p>

<ul>
  <li>No queueing system; ActiveJob should be added</li>
  <li>Take care to reload context when re-delivering the subscription. (see <span class='object_link'><a href="../Query.html#subscription_update%3F-instance_method" title="GraphQL::Query#subscription_update? (method)">Query#subscription_update?</a></span>)</li>
  <li>Avoid the async ActionCable adapter and use the redis or PostgreSQL adapters instead. Otherwise calling #trigger won’t work from background jobs or the Rails console.</li>
</ul>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <h4 class="tag_title">Examples:</h4>
    
      
        <h5 class="example_title"><div class='inline'><p>Adding ActionCableSubscriptions to your schema</p>
</div></h5>
      
      <pre class="example code"><code><span class='kw'>class</span> <span class='const'>MySchema</span> <span class='op'>&lt;</span> <span class='const'><span class='object_link'><a href="../../GraphQL.html" title="GraphQL (module)">GraphQL</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Schema.html" title="GraphQL::Schema (class)">Schema</a></span></span>
  <span class='comment'># ...
</span>  <span class='id identifier rubyid_use'>use</span> <span class='const'><span class='object_link'><a href="../../GraphQL.html" title="GraphQL (module)">GraphQL</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Subscriptions.html" title="GraphQL::Subscriptions (class)">Subscriptions</a></span></span><span class='op'>::</span><span class='const'>ActionCableSubscriptions</span>
<span class='kw'>end</span></code></pre>
    
      
        <h5 class="example_title"><div class='inline'><p>Implementing a channel for GraphQL Subscriptions</p>
</div></h5>
      
      <pre class="example code"><code><span class='kw'>class</span> <span class='const'>GraphqlChannel</span> <span class='op'>&lt;</span> <span class='const'>ApplicationCable</span><span class='op'>::</span><span class='const'>Channel</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_subscribed'>subscribed</span>
    <span class='ivar'>@subscription_ids</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_execute'>execute</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_query'>query</span> <span class='op'>=</span> <span class='id identifier rubyid_data'>data</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>query</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_variables'>variables</span> <span class='op'>=</span> <span class='id identifier rubyid_ensure_hash'>ensure_hash</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>variables</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_operation_name'>operation_name</span> <span class='op'>=</span> <span class='id identifier rubyid_data'>data</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>operationName</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_context'>context</span> <span class='op'>=</span> <span class='lbrace'>{</span>
      <span class='comment'># Re-implement whatever context methods you need
</span>      <span class='comment'># in this channel or ApplicationCable::Channel
</span>      <span class='comment'># current_user: current_user,
</span>      <span class='comment'># Make sure the channel is in the context
</span>      <span class='label'>channel:</span> <span class='kw'>self</span><span class='comma'>,</span>
    <span class='rbrace'>}</span>

    <span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='const'>MySchema</span><span class='period'>.</span><span class='id identifier rubyid_execute'>execute</span><span class='lparen'>(</span>
      <span class='id identifier rubyid_query'>query</span><span class='comma'>,</span>
      <span class='label'>context:</span> <span class='id identifier rubyid_context'>context</span><span class='comma'>,</span>
      <span class='label'>variables:</span> <span class='id identifier rubyid_variables'>variables</span><span class='comma'>,</span>
      <span class='label'>operation_name:</span> <span class='id identifier rubyid_operation_name'>operation_name</span>
    <span class='rparen'>)</span>

    <span class='id identifier rubyid_payload'>payload</span> <span class='op'>=</span> <span class='lbrace'>{</span>
      <span class='label'>result:</span> <span class='id identifier rubyid_result'>result</span><span class='period'>.</span><span class='id identifier rubyid_to_h'>to_h</span><span class='comma'>,</span>
      <span class='label'>more:</span> <span class='id identifier rubyid_result'>result</span><span class='period'>.</span><span class='id identifier rubyid_subscription?'>subscription?</span><span class='comma'>,</span>
    <span class='rbrace'>}</span>

    <span class='comment'># Track the subscription here so we can remove it
</span>    <span class='comment'># on unsubscribe.
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_result'>result</span><span class='period'>.</span><span class='id identifier rubyid_context'>context</span><span class='lbracket'>[</span><span class='symbol'>:subscription_id</span><span class='rbracket'>]</span>
      <span class='ivar'>@subscription_ids</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_result'>result</span><span class='period'>.</span><span class='id identifier rubyid_context'>context</span><span class='lbracket'>[</span><span class='symbol'>:subscription_id</span><span class='rbracket'>]</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_transmit'>transmit</span><span class='lparen'>(</span><span class='id identifier rubyid_payload'>payload</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_unsubscribed'>unsubscribed</span>
    <span class='ivar'>@subscription_ids</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_sid'>sid</span><span class='op'>|</span>
      <span class='const'>MySchema</span><span class='period'>.</span><span class='id identifier rubyid_subscriptions'>subscriptions</span><span class='period'>.</span><span class='id identifier rubyid_delete_subscription'>delete_subscription</span><span class='lparen'>(</span><span class='id identifier rubyid_sid'>sid</span><span class='rparen'>)</span>
    <span class='rbrace'>}</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_private'>private</span>

    <span class='kw'>def</span> <span class='id identifier rubyid_ensure_hash'>ensure_hash</span><span class='lparen'>(</span><span class='id identifier rubyid_ambiguous_param'>ambiguous_param</span><span class='rparen'>)</span>
      <span class='kw'>case</span> <span class='id identifier rubyid_ambiguous_param'>ambiguous_param</span>
      <span class='kw'>when</span> <span class='const'>String</span>
        <span class='kw'>if</span> <span class='id identifier rubyid_ambiguous_param'>ambiguous_param</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span>
          <span class='id identifier rubyid_ensure_hash'>ensure_hash</span><span class='lparen'>(</span><span class='const'>JSON</span><span class='period'>.</span><span class='id identifier rubyid_parse'>parse</span><span class='lparen'>(</span><span class='id identifier rubyid_ambiguous_param'>ambiguous_param</span><span class='rparen'>)</span><span class='rparen'>)</span>
        <span class='kw'>else</span>
          <span class='lbrace'>{</span><span class='rbrace'>}</span>
        <span class='kw'>end</span>
      <span class='kw'>when</span> <span class='const'>Hash</span><span class='comma'>,</span> <span class='const'>ActionController</span><span class='op'>::</span><span class='const'>Parameters</span>
        <span class='id identifier rubyid_ambiguous_param'>ambiguous_param</span>
      <span class='kw'>when</span> <span class='kw'>nil</span>
        <span class='lbrace'>{</span><span class='rbrace'>}</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Unexpected parameter: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_ambiguous_param'>ambiguous_param</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>
    
  </div>


</div>
  
    <h2>
      Constant Summary
      <small><a href="#" class="constants_summary_toggle">collapse</a></small>
    </h2>

    <dl class="constants">
      
        <dt id="SUBSCRIPTION_PREFIX-constant" class="">SUBSCRIPTION_PREFIX =
          
        </dt>
        <dd><pre class="code"><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>graphql-subscription:</span><span class='tstring_end'>&quot;</span></span></pre></dd>
      
        <dt id="EVENT_PREFIX-constant" class="">EVENT_PREFIX =
          
        </dt>
        <dd><pre class="code"><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>graphql-event:</span><span class='tstring_end'>&quot;</span></span></pre></dd>
      
    </dl>
  






  <h2>Instance Attribute Summary</h2>
  
  <h3 class="inherited">Attributes inherited from <span class='object_link'><a href="../Subscriptions.html" title="GraphQL::Subscriptions (class)">GraphQL::Subscriptions</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../Subscriptions.html#default_broadcastable-instance_method" title="GraphQL::Subscriptions#default_broadcastable (method)">#default_broadcastable</a></span></p>


  
    <h2>
      Instance Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#delete_subscription-instance_method" title="#delete_subscription (instance method)">#<strong>delete_subscription</strong>(subscription_id)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>The channel was closed, forget about it.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#deliver-instance_method" title="#deliver (instance method)">#<strong>deliver</strong>(subscription_id, result)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>This subscription was re-evaluated.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#execute_all-instance_method" title="#execute_all (instance method)">#<strong>execute_all</strong>(event, object)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>An event was triggered; Push the data over ActionCable.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">#<strong>initialize</strong>(serializer: Serialize, namespace: &#39;&#39;, action_cable: ActionCable, action_cable_coder: ActiveSupport::JSON, **rest)  &#x21d2; ActionCableSubscriptions </a>
    

    
  </span>
  
  
    <span class="note title constructor">constructor</span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>A new instance of ActionCableSubscriptions.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#load_action_cable_message-instance_method" title="#load_action_cable_message (instance method)">#<strong>load_action_cable_message</strong>(message, context)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>This is called to turn an ActionCable-broadcasted string (JSON) into a query-ready application object.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#read_subscription-instance_method" title="#read_subscription (instance method)">#<strong>read_subscription</strong>(subscription_id)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Return the query from “storage” (in memory).</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#setup_stream-instance_method" title="#setup_stream (instance method)">#<strong>setup_stream</strong>(channel, initial_event)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Every subscribing channel is listening here, but only one of them takes any action.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#write_subscription-instance_method" title="#write_subscription (instance method)">#<strong>write_subscription</strong>(query, events)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>A query was run where these events were subscribed to.</p>
</div></span>
  
</li>

      
    </ul>
  


  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods inherited from <span class='object_link'><a href="../Subscriptions.html" title="GraphQL::Subscriptions (class)">GraphQL::Subscriptions</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../Subscriptions.html#broadcastable%3F-instance_method" title="GraphQL::Subscriptions#broadcastable? (method)">#broadcastable?</a></span>, <span class='object_link'><a href="../Subscriptions.html#build_id-instance_method" title="GraphQL::Subscriptions#build_id (method)">#build_id</a></span>, <span class='object_link'><a href="../Subscriptions.html#execute-instance_method" title="GraphQL::Subscriptions#execute (method)">#execute</a></span>, <span class='object_link'><a href="../Subscriptions.html#execute_update-instance_method" title="GraphQL::Subscriptions#execute_update (method)">#execute_update</a></span>, <span class='object_link'><a href="../Subscriptions.html#normalize_name-instance_method" title="GraphQL::Subscriptions#normalize_name (method)">#normalize_name</a></span>, <span class='object_link'><a href="../Subscriptions.html#trigger-instance_method" title="GraphQL::Subscriptions#trigger (method)">#trigger</a></span>, <span class='object_link'><a href="../Subscriptions.html#use-class_method" title="GraphQL::Subscriptions.use (method)">use</a></span>, <span class='object_link'><a href="../Subscriptions.html#validate_update%3F-instance_method" title="GraphQL::Subscriptions#validate_update? (method)">#validate_update?</a></span></p>
<div id="constructor_details" class="method_details_list">
  <h2>Constructor Details</h2>
  
    <div class="method_details first">
  <h3 class="signature first" id="initialize-instance_method">
  
    #<strong>initialize</strong>(serializer: Serialize, namespace: &#39;&#39;, action_cable: ActionCable, action_cable_coder: ActiveSupport::JSON, **rest)  &#x21d2; <tt><span class='object_link'><a href="" title="GraphQL::Subscriptions::ActionCableSubscriptions (class)">ActionCableSubscriptions</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Returns a new instance of ActionCableSubscriptions.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>serializer</span>
      
      
        <span class='type'>(<tt>&lt;#dump(obj), #load(string)] Used for serializing messages before handing them to `.broadcast(msg)`</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>Serialize</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>erializer [&lt;#dump(obj), #load(string)] Used for serializing messages before handing them to <code>.broadcast(msg)</code></p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>namespace</span>
      
      
        <span class='type'>(<tt>string</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>&#39;&#39;</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Used to namespace events and subscriptions (default: ‘’)</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/graphql/subscriptions/action_cable_subscriptions.rb', line 90</span>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='label'>serializer:</span> <span class='const'><span class='object_link'><a href="Serialize.html" title="GraphQL::Subscriptions::Serialize (module)">Serialize</a></span></span><span class='comma'>,</span> <span class='label'>namespace:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>action_cable:</span> <span class='const'>ActionCable</span><span class='comma'>,</span> <span class='label'>action_cable_coder:</span> <span class='const'>ActiveSupport</span><span class='op'>::</span><span class='const'>JSON</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_rest'>rest</span><span class='rparen'>)</span>
  <span class='comment'># A per-process map of subscriptions to deliver.
</span>  <span class='comment'># This is provided by Rails, so let&#39;s use it
</span>  <span class='ivar'>@subscriptions</span> <span class='op'>=</span> <span class='const'>Concurrent</span><span class='op'>::</span><span class='const'>Map</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  <span class='ivar'>@events</span> <span class='op'>=</span> <span class='const'>Concurrent</span><span class='op'>::</span><span class='const'>Map</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_h'>h</span><span class='comma'>,</span> <span class='id identifier rubyid_k'>k</span><span class='op'>|</span>
    <span class='id identifier rubyid_h'>h</span><span class='period'>.</span><span class='id identifier rubyid_compute_if_absent'>compute_if_absent</span><span class='lparen'>(</span><span class='id identifier rubyid_k'>k</span><span class='rparen'>)</span> <span class='kw'>do</span>
      <span class='const'>Concurrent</span><span class='op'>::</span><span class='const'>Map</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_h2'>h2</span><span class='comma'>,</span> <span class='id identifier rubyid_k2'>k2</span><span class='op'>|</span>
        <span class='id identifier rubyid_h2'>h2</span><span class='period'>.</span><span class='id identifier rubyid_compute_if_absent'>compute_if_absent</span><span class='lparen'>(</span><span class='id identifier rubyid_k2'>k2</span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='const'>Concurrent</span><span class='op'>::</span><span class='const'>Array</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='rbrace'>}</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='ivar'>@action_cable</span> <span class='op'>=</span> <span class='id identifier rubyid_action_cable'>action_cable</span>
  <span class='ivar'>@action_cable_coder</span> <span class='op'>=</span> <span class='id identifier rubyid_action_cable_coder'>action_cable_coder</span>
  <span class='ivar'>@serializer</span> <span class='op'>=</span> <span class='id identifier rubyid_serializer'>serializer</span>
  <span class='ivar'>@serialize_with_context</span> <span class='op'>=</span> <span class='kw'>case</span> <span class='ivar'>@serializer</span><span class='period'>.</span><span class='id identifier rubyid_method'>method</span><span class='lparen'>(</span><span class='symbol'>:load</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_arity'>arity</span>
  <span class='kw'>when</span> <span class='int'>1</span>
    <span class='kw'>false</span>
  <span class='kw'>when</span> <span class='int'>2</span>
    <span class='kw'>true</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='ivar'>@serializer</span><span class='embexpr_end'>}</span><span class='tstring_content'> must respond to `.load` accepting one or two arguments</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
  <span class='ivar'>@transmit_ns</span> <span class='op'>=</span> <span class='id identifier rubyid_namespace'>namespace</span>
  <span class='kw'>super</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
  
</div>


  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="delete_subscription-instance_method">
  
    #<strong>delete_subscription</strong>(subscription_id)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>The channel was closed, forget about it.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/graphql/subscriptions/action_cable_subscriptions.rb', line 225</span>

<span class='kw'>def</span> <span class='id identifier rubyid_delete_subscription'>delete_subscription</span><span class='lparen'>(</span><span class='id identifier rubyid_subscription_id'>subscription_id</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_query'>query</span> <span class='op'>=</span> <span class='ivar'>@subscriptions</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='id identifier rubyid_subscription_id'>subscription_id</span><span class='rparen'>)</span>
  <span class='comment'># In case this came from the server, tell the client to unsubscribe:
</span>  <span class='ivar'>@action_cable</span><span class='period'>.</span><span class='id identifier rubyid_server'>server</span><span class='period'>.</span><span class='id identifier rubyid_broadcast'>broadcast</span><span class='lparen'>(</span><span class='id identifier rubyid_stream_subscription_name'>stream_subscription_name</span><span class='lparen'>(</span><span class='id identifier rubyid_subscription_id'>subscription_id</span><span class='rparen'>)</span><span class='comma'>,</span> <span class='lbrace'>{</span> <span class='label'>more:</span> <span class='kw'>false</span> <span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='comment'># This can be `nil` when `.trigger` happens inside an unsubscribed ActionCable channel,
</span>  <span class='comment'># see https://github.com/rmosolgo/graphql-ruby/issues/2478
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_query'>query</span>
    <span class='id identifier rubyid_events'>events</span> <span class='op'>=</span> <span class='id identifier rubyid_query'>query</span><span class='period'>.</span><span class='id identifier rubyid_context'>context</span><span class='period'>.</span><span class='id identifier rubyid_namespace'>namespace</span><span class='lparen'>(</span><span class='symbol'>:subscriptions</span><span class='rparen'>)</span><span class='lbracket'>[</span><span class='symbol'>:events</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_events'>events</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_event'>event</span><span class='op'>|</span>
      <span class='id identifier rubyid_ev_by_fingerprint'>ev_by_fingerprint</span> <span class='op'>=</span> <span class='ivar'>@events</span><span class='lbracket'>[</span><span class='id identifier rubyid_event'>event</span><span class='period'>.</span><span class='id identifier rubyid_topic'>topic</span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_ev_for_fingerprint'>ev_for_fingerprint</span> <span class='op'>=</span> <span class='id identifier rubyid_ev_by_fingerprint'>ev_by_fingerprint</span><span class='lbracket'>[</span><span class='id identifier rubyid_event'>event</span><span class='period'>.</span><span class='id identifier rubyid_fingerprint'>fingerprint</span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_ev_for_fingerprint'>ev_for_fingerprint</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='id identifier rubyid_event'>event</span><span class='rparen'>)</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_ev_for_fingerprint'>ev_for_fingerprint</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
        <span class='id identifier rubyid_ev_by_fingerprint'>ev_by_fingerprint</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='id identifier rubyid_event'>event</span><span class='period'>.</span><span class='id identifier rubyid_fingerprint'>fingerprint</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="deliver-instance_method">
  
    #<strong>deliver</strong>(subscription_id, result)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>This subscription was re-evaluated.
Send it to the specific stream where this client was waiting.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


126
127
128
129
130</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/graphql/subscriptions/action_cable_subscriptions.rb', line 126</span>

<span class='kw'>def</span> <span class='id identifier rubyid_deliver'>deliver</span><span class='lparen'>(</span><span class='id identifier rubyid_subscription_id'>subscription_id</span><span class='comma'>,</span> <span class='id identifier rubyid_result'>result</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_has_more'>has_more</span> <span class='op'>=</span> <span class='op'>!</span><span class='id identifier rubyid_result'>result</span><span class='period'>.</span><span class='id identifier rubyid_context'>context</span><span class='period'>.</span><span class='id identifier rubyid_namespace'>namespace</span><span class='lparen'>(</span><span class='symbol'>:subscriptions</span><span class='rparen'>)</span><span class='lbracket'>[</span><span class='symbol'>:final_update</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_payload'>payload</span> <span class='op'>=</span> <span class='lbrace'>{</span> <span class='label'>result:</span> <span class='id identifier rubyid_result'>result</span><span class='period'>.</span><span class='id identifier rubyid_to_h'>to_h</span><span class='comma'>,</span> <span class='label'>more:</span> <span class='id identifier rubyid_has_more'>has_more</span> <span class='rbrace'>}</span>
  <span class='ivar'>@action_cable</span><span class='period'>.</span><span class='id identifier rubyid_server'>server</span><span class='period'>.</span><span class='id identifier rubyid_broadcast'>broadcast</span><span class='lparen'>(</span><span class='id identifier rubyid_stream_subscription_name'>stream_subscription_name</span><span class='lparen'>(</span><span class='id identifier rubyid_subscription_id'>subscription_id</span><span class='rparen'>)</span><span class='comma'>,</span> <span class='id identifier rubyid_payload'>payload</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="execute_all-instance_method">
  
    #<strong>execute_all</strong>(event, object)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>An event was triggered; Push the data over ActionCable.
Subscribers will re-evaluate locally.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


118
119
120
121
122</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/graphql/subscriptions/action_cable_subscriptions.rb', line 118</span>

<span class='kw'>def</span> <span class='id identifier rubyid_execute_all'>execute_all</span><span class='lparen'>(</span><span class='id identifier rubyid_event'>event</span><span class='comma'>,</span> <span class='id identifier rubyid_object'>object</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_stream'>stream</span> <span class='op'>=</span> <span class='id identifier rubyid_stream_event_name'>stream_event_name</span><span class='lparen'>(</span><span class='id identifier rubyid_event'>event</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_message'>message</span> <span class='op'>=</span> <span class='ivar'>@serializer</span><span class='period'>.</span><span class='id identifier rubyid_dump'>dump</span><span class='lparen'>(</span><span class='id identifier rubyid_object'>object</span><span class='rparen'>)</span>
  <span class='ivar'>@action_cable</span><span class='period'>.</span><span class='id identifier rubyid_server'>server</span><span class='period'>.</span><span class='id identifier rubyid_broadcast'>broadcast</span><span class='lparen'>(</span><span class='id identifier rubyid_stream'>stream</span><span class='comma'>,</span> <span class='id identifier rubyid_message'>message</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="load_action_cable_message-instance_method">
  
    #<strong>load_action_cable_message</strong>(message, context)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>This is called to turn an ActionCable-broadcasted string (JSON)
into a query-ready application object.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>message</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>n ActionCable-broadcasted string (JSON)</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>context</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../Query/Context.html" title="GraphQL::Query::Context (class)">GraphQL::Query::Context</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>the context of the first event for a given subscription fingerprint</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


198
199
200
201
202
203
204</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/graphql/subscriptions/action_cable_subscriptions.rb', line 198</span>

<span class='kw'>def</span> <span class='id identifier rubyid_load_action_cable_message'>load_action_cable_message</span><span class='lparen'>(</span><span class='id identifier rubyid_message'>message</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='ivar'>@serialize_with_context</span>
    <span class='ivar'>@serializer</span><span class='period'>.</span><span class='id identifier rubyid_load'>load</span><span class='lparen'>(</span><span class='id identifier rubyid_message'>message</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span><span class='rparen'>)</span>
  <span class='kw'>else</span>
    <span class='ivar'>@serializer</span><span class='period'>.</span><span class='id identifier rubyid_load'>load</span><span class='lparen'>(</span><span class='id identifier rubyid_message'>message</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="read_subscription-instance_method">
  
    #<strong>read_subscription</strong>(subscription_id)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Return the query from “storage” (in memory)</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/graphql/subscriptions/action_cable_subscriptions.rb', line 207</span>

<span class='kw'>def</span> <span class='id identifier rubyid_read_subscription'>read_subscription</span><span class='lparen'>(</span><span class='id identifier rubyid_subscription_id'>subscription_id</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_query'>query</span> <span class='op'>=</span> <span class='ivar'>@subscriptions</span><span class='lbracket'>[</span><span class='id identifier rubyid_subscription_id'>subscription_id</span><span class='rbracket'>]</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_query'>query</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
    <span class='comment'># This can happen when a subscription is triggered from an unsubscribed channel,
</span>    <span class='comment'># see https://github.com/rmosolgo/graphql-ruby/issues/2478.
</span>    <span class='comment'># (This `nil` is handled by `#execute_update`)
</span>    <span class='kw'>nil</span>
  <span class='kw'>else</span>
    <span class='lbrace'>{</span>
      <span class='label'>query_string:</span> <span class='id identifier rubyid_query'>query</span><span class='period'>.</span><span class='id identifier rubyid_query_string'>query_string</span><span class='comma'>,</span>
      <span class='label'>variables:</span> <span class='id identifier rubyid_query'>query</span><span class='period'>.</span><span class='id identifier rubyid_provided_variables'>provided_variables</span><span class='comma'>,</span>
      <span class='label'>context:</span> <span class='id identifier rubyid_query'>query</span><span class='period'>.</span><span class='id identifier rubyid_context'>context</span><span class='period'>.</span><span class='id identifier rubyid_to_h'>to_h</span><span class='comma'>,</span>
      <span class='label'>operation_name:</span> <span class='id identifier rubyid_query'>query</span><span class='period'>.</span><span class='id identifier rubyid_operation_name'>operation_name</span><span class='comma'>,</span>
    <span class='rbrace'>}</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="setup_stream-instance_method">
  
    #<strong>setup_stream</strong>(channel, initial_event)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Every subscribing channel is listening here, but only one of them takes any action.
This is so we can reuse payloads when possible, and make one payload to send to
all subscribers.</p>

<p>But the problem is, any channel could close at any time, so each channel has to
be ready to take over the primary position.</p>

<p>To make sure there’s always one-and-only-one channel building payloads,
let the listener belonging to the first event on the list be
the one to build and publish payloads.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/graphql/subscriptions/action_cable_subscriptions.rb', line 167</span>

<span class='kw'>def</span> <span class='id identifier rubyid_setup_stream'>setup_stream</span><span class='lparen'>(</span><span class='id identifier rubyid_channel'>channel</span><span class='comma'>,</span> <span class='id identifier rubyid_initial_event'>initial_event</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_topic'>topic</span> <span class='op'>=</span> <span class='id identifier rubyid_initial_event'>initial_event</span><span class='period'>.</span><span class='id identifier rubyid_topic'>topic</span>
  <span class='id identifier rubyid_event_stream'>event_stream</span> <span class='op'>=</span> <span class='id identifier rubyid_stream_event_name'>stream_event_name</span><span class='lparen'>(</span><span class='id identifier rubyid_initial_event'>initial_event</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_channel'>channel</span><span class='period'>.</span><span class='id identifier rubyid_stream_from'>stream_from</span><span class='lparen'>(</span><span class='id identifier rubyid_event_stream'>event_stream</span><span class='comma'>,</span> <span class='label'>coder:</span> <span class='ivar'>@action_cable_coder</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_message'>message</span><span class='op'>|</span>
    <span class='id identifier rubyid_events_by_fingerprint'>events_by_fingerprint</span> <span class='op'>=</span> <span class='ivar'>@events</span><span class='lbracket'>[</span><span class='id identifier rubyid_topic'>topic</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_object'>object</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='id identifier rubyid_events_by_fingerprint'>events_by_fingerprint</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid__fingerprint'>_fingerprint</span><span class='comma'>,</span> <span class='id identifier rubyid_events'>events</span><span class='op'>|</span>
      <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_events'>events</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_events'>events</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span> <span class='op'>==</span> <span class='id identifier rubyid_initial_event'>initial_event</span>
        <span class='comment'># The fingerprint has told us that this response should be shared by all subscribers,
</span>        <span class='comment'># so just run it once, then deliver the result to every subscriber
</span>        <span class='id identifier rubyid_first_event'>first_event</span> <span class='op'>=</span> <span class='id identifier rubyid_events'>events</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
        <span class='id identifier rubyid_first_subscription_id'>first_subscription_id</span> <span class='op'>=</span> <span class='id identifier rubyid_first_event'>first_event</span><span class='period'>.</span><span class='id identifier rubyid_context'>context</span><span class='period'>.</span><span class='id identifier rubyid_fetch'>fetch</span><span class='lparen'>(</span><span class='symbol'>:subscription_id</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_object'>object</span> <span class='op'>||=</span> <span class='id identifier rubyid_load_action_cable_message'>load_action_cable_message</span><span class='lparen'>(</span><span class='id identifier rubyid_message'>message</span><span class='comma'>,</span> <span class='id identifier rubyid_first_event'>first_event</span><span class='period'>.</span><span class='id identifier rubyid_context'>context</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='id identifier rubyid_execute_update'>execute_update</span><span class='lparen'>(</span><span class='id identifier rubyid_first_subscription_id'>first_subscription_id</span><span class='comma'>,</span> <span class='id identifier rubyid_first_event'>first_event</span><span class='comma'>,</span> <span class='id identifier rubyid_object'>object</span><span class='rparen'>)</span>
        <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_result'>result</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
          <span class='comment'># Having calculated the result _once_, send the same payload to all subscribers
</span>          <span class='id identifier rubyid_events'>events</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_event'>event</span><span class='op'>|</span>
            <span class='id identifier rubyid_subscription_id'>subscription_id</span> <span class='op'>=</span> <span class='id identifier rubyid_event'>event</span><span class='period'>.</span><span class='id identifier rubyid_context'>context</span><span class='period'>.</span><span class='id identifier rubyid_fetch'>fetch</span><span class='lparen'>(</span><span class='symbol'>:subscription_id</span><span class='rparen'>)</span>
            <span class='id identifier rubyid_deliver'>deliver</span><span class='lparen'>(</span><span class='id identifier rubyid_subscription_id'>subscription_id</span><span class='comma'>,</span> <span class='id identifier rubyid_result'>result</span><span class='rparen'>)</span>
          <span class='kw'>end</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
    <span class='kw'>nil</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="write_subscription-instance_method">
  
    #<strong>write_subscription</strong>(query, events)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>A query was run where these events were subscribed to.
Store them in memory in <em>this</em> ActionCable frontend.
It will receive notifications when events come in
and re-evaluate the query locally.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/graphql/subscriptions/action_cable_subscriptions.rb', line 136</span>

<span class='kw'>def</span> <span class='id identifier rubyid_write_subscription'>write_subscription</span><span class='lparen'>(</span><span class='id identifier rubyid_query'>query</span><span class='comma'>,</span> <span class='id identifier rubyid_events'>events</span><span class='rparen'>)</span>
  <span class='kw'>unless</span> <span class='lparen'>(</span><span class='id identifier rubyid_channel'>channel</span> <span class='op'>=</span> <span class='id identifier rubyid_query'>query</span><span class='period'>.</span><span class='id identifier rubyid_context'>context</span><span class='lbracket'>[</span><span class='symbol'>:channel</span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><span class='object_link'><a href="../../GraphQL.html" title="GraphQL (module)">GraphQL</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Error.html" title="GraphQL::Error (class)">Error</a></span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>This GraphQL Subscription client does not support the transport protocol expected</span><span class='tstring_end'>&quot;</span></span>\
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>by the backend Subscription Server implementation (graphql-ruby ActionCableSubscriptions in this case).</span><span class='tstring_end'>&quot;</span></span>\
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Some official client implementation including Apollo (https://graphql-ruby.org/javascript_client/apollo_subscriptions.html), </span><span class='tstring_end'>&quot;</span></span>\
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Relay Modern (https://graphql-ruby.org/javascript_client/relay_subscriptions.html#actioncable).</span><span class='tstring_end'>&quot;</span></span>\
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>GraphiQL via `graphiql-rails` may not work out of box (#1051).</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_subscription_id'>subscription_id</span> <span class='op'>=</span> <span class='id identifier rubyid_query'>query</span><span class='period'>.</span><span class='id identifier rubyid_context'>context</span><span class='lbracket'>[</span><span class='symbol'>:subscription_id</span><span class='rbracket'>]</span> <span class='op'>||=</span> <span class='id identifier rubyid_build_id'>build_id</span>
  <span class='id identifier rubyid_stream'>stream</span> <span class='op'>=</span> <span class='id identifier rubyid_stream_subscription_name'>stream_subscription_name</span><span class='lparen'>(</span><span class='id identifier rubyid_subscription_id'>subscription_id</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_channel'>channel</span><span class='period'>.</span><span class='id identifier rubyid_stream_from'>stream_from</span><span class='lparen'>(</span><span class='id identifier rubyid_stream'>stream</span><span class='rparen'>)</span>
  <span class='ivar'>@subscriptions</span><span class='lbracket'>[</span><span class='id identifier rubyid_subscription_id'>subscription_id</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_query'>query</span>
  <span class='id identifier rubyid_events'>events</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_event'>event</span><span class='op'>|</span>
    <span class='comment'># Setup a new listener to run all events with this topic in this process
</span>    <span class='id identifier rubyid_setup_stream'>setup_stream</span><span class='lparen'>(</span><span class='id identifier rubyid_channel'>channel</span><span class='comma'>,</span> <span class='id identifier rubyid_event'>event</span><span class='rparen'>)</span>
    <span class='comment'># Add this event to the list of events to be updated
</span>    <span class='ivar'>@events</span><span class='lbracket'>[</span><span class='id identifier rubyid_event'>event</span><span class='period'>.</span><span class='id identifier rubyid_topic'>topic</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id identifier rubyid_event'>event</span><span class='period'>.</span><span class='id identifier rubyid_fingerprint'>fingerprint</span><span class='rbracket'>]</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_event'>event</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  Generated on Mon Apr 14 16:11:05 2025 by
  <a href="https://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.37 (ruby-3.2.8).
</div>

    </div>
  </body>
</html>