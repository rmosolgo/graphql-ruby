<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
      <title>GraphQL Pro - Defer - Server Setup</title>
    
    <link href="https://fonts.googleapis.com/css?family=Rubik:300,400,700" rel="stylesheet" />
    <link rel="stylesheet" href="/css/main.css">
    <link rel="icon" href="/graphql-ruby-icon.png">
  </head>
  <body>
    <div class="header">
      <div class="header-container">
        <div class="nav">
          <a href="/" class="img-link">
            <img src="/graphql-ruby.png" alt="GraphQL Ruby Logo" />
          </a>
          <a href="/getting_started">Get Started</a>
          <a href="/guides">Guides</a>
          <a href="/api-doc/2.0.22/">API</a>
          <a href="https://tinyletter.com/graphql-ruby">Newsletter</a>
          <a href="https://github.com/rmosolgo/graphql-ruby">Source Code</a>
          <a href="https://graphql.pro">Upgrade to Pro</a>
          <input
            class="search-input"
            onkeyup="GraphQLRubySearch.run(this)"
            type="text"
            placeholder="Search the docs..."
          />
        </div>
      </div>
      <div class="search-results-container">
        <div id="search-results">
        </div>
      </div>
    </div>
    <div class="container">
      <ul class="breadcrumb">
  <li><a href="/guides">Guides</a></li>
  <li>
    <select class="jump-to-select" onchange="navigateToSelected(this)">
      
        <option  data-target="/schema/definition.html">Schema</option>
      
        <option  data-target="/queries/executing_queries.html">Queries</option>
      
        <option  data-target="/type_definitions/objects.html">Type Definitions</option>
      
        <option  data-target="/authorization/overview.html">Authorization</option>
      
        <option  data-target="/fields/introduction.html">Fields</option>
      
        <option  data-target="/mutations/mutation_root.html">Mutations</option>
      
        <option  data-target="/errors/overview.html">Errors</option>
      
        <option  data-target="/pagination/overview.html">Pagination</option>
      
        <option  data-target="/relay/range_add.html">Relay</option>
      
        <option  data-target="/dataloader/overview.html">Dataloader</option>
      
        <option  data-target="/subscriptions/overview.html">Subscriptions</option>
      
        <option  data-target="/pro/home.html">GraphQL Pro</option>
      
        <option  data-target="/operation_store/overview.html">GraphQL Pro - OperationStore</option>
      
        <option  selected data-target="/defer/overview.html">GraphQL Pro - Defer</option>
      
        <option  data-target="/limiters/overview.html">GraphQL Enterprise - Rate Limiters</option>
      
        <option  data-target="/object_cache/overview.html">GraphQL Enterprise - Object Cache</option>
      
        <option  data-target="/changesets/overview.html">GraphQL Enterprise - Changesets</option>
      
        <option  data-target="/javascript_client/overview.html">JavaScript Client</option>
      
        <option  data-target="/language_tools/visitor.html">Language Tools</option>
      
        <option  data-target="/testing/overview.html">Testing</option>
      
        <option  data-target="/development.html">Other</option>
      
    </select>
  </li>
  <li>
    <select class="jump-to-select" onchange="navigateToSelected(this)">
      
        <option  data-target="/defer/overview.html">Overview</option>
      
        <option  selected data-target="/defer/setup.html">Server Setup</option>
      
        <option  data-target="/defer/usage.html">Usage</option>
      
        <option  data-target="/defer/stream.html">Stream</option>
      
    </select>
  </li>
</ul>


  <div class="pro-header">
    <p>
      <strong>⚡️ Pro Feature ⚡️</strong>
      <span style="font-style: italic;">
        This feature is bundled with <a href="https://graphql.pro">GraphQL-Pro</a>.
      </span>
    </p>
  </div>


<h1 class="guide-header">Server Setup</h1>
<div class="guide-table-of-contents"><div class="table-of-contents">
  <h3 class="contents-header">Contents</h3>
  <ol class='contents-list'><li class='contents-entry'><a href='#updating-the-gems'>Updating the gems
</a></li><li class='contents-entry'><a href='#adding-defer-to-your-schema'>Adding <code>@defer</code> to your schema
</a></li><li class='contents-entry'><a href='#sending-streaming-responses'>Sending streaming responses
</a><ol class='contents-list'><li class='contents-entry'><a href='#checking-for-deferrals'>Checking for deferrals
</a></li><li class='contents-entry'><a href='#working-with-deferrals'>Working with deferrals
</a></li><li class='contents-entry'><a href='#example-rails-with-apollo-client'>Example: Rails with Apollo Client
</a></li></ol></li><li class='contents-entry'><a href='#with-graphql-batch'>With GraphQL-Batch
</a></li><li class='contents-entry'><a href='#next-steps'>Next Steps
</a></li></ol>
</div>
</div>
<div class="guide-container">
  <p>Before using <code class="language-plaintext highlighter-rouge">@defer</code> in queries, you have to:</p>

<ul>
  <li>Update <code class="language-plaintext highlighter-rouge">graphql</code> and <code class="language-plaintext highlighter-rouge">graphql-pro</code> gems</li>
  <li>Add <code class="language-plaintext highlighter-rouge">@defer</code> to your GraphQL schema</li>
  <li>Update your HTTP handlers (eg, Rails controllers) to send streaming responses</li>
  <li>Optionally, customize <code class="language-plaintext highlighter-rouge">@defer</code> to work with GraphQL-Batch</li>
</ul>

<p>You can also see a <a href="https://github.com/rmosolgo/graphql_defer_example">full Rails &amp; Apollo-Client demo</a>.</p>

<h2 id="updating-the-gems">Updating the gems</h2>

<p>GraphQL-Ruby 1.9+ and GraphQL-Pro 1.10+ are required:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gem</span> <span class="s2">"graphql"</span><span class="p">,</span> <span class="s2">"~&gt;1.9"</span>
<span class="n">gem</span> <span class="s2">"graphql-pro"</span><span class="p">,</span> <span class="s2">"~&gt;1.10"</span>
</code></pre></div></div>

<p>And then install them:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ bundle update graphql graphql-pro
</code></pre></div></div>

<h2 id="adding-defer-to-your-schema">Adding <code class="language-plaintext highlighter-rouge">@defer</code> to your schema</h2>

<p>Then, add <code class="language-plaintext highlighter-rouge">GraphQL::Pro::Defer</code> to your schema as a plugin:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MySchema</span> <span class="o">&lt;</span> <span class="no">GraphQL</span><span class="o">::</span><span class="no">Schema</span>
  <span class="n">use</span> <span class="no">GraphQL</span><span class="o">::</span><span class="no">Pro</span><span class="o">::</span><span class="no">Defer</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This will:</p>

<ul>
  <li>Attach a <a href="/type_definitions/directives">custom directive</a> called <code class="language-plaintext highlighter-rouge">@defer</code></li>
  <li>Add instrumentation to queries to track deferred work and execute it later</li>
</ul>

<h2 id="sending-streaming-responses">Sending streaming responses</h2>

<p>Many web frameworks have support for streaming responses, for example:</p>

<ul>
  <li>Rails has <a href="https://api.rubyonrails.org/classes/ActionController/Live.html">ActionController::Live</a></li>
  <li>Sinatra has <a href="http://sinatrarb.com/contrib/streaming.html">Sinatra::Streaming</a></li>
  <li>Hanami::Controller can <a href="https://github.com/hanami/controller#streamed-responses">stream responses</a></li>
</ul>

<p>See below for how to integrate GraphQL’s deferred patches with a streaming response API.</p>

<p>To investigate support with a web framework, please <a href="https://github.com/rmosolgo/graphql-ruby/issues/new?title=Server support for @defer with ..." target="_blank">open an issue</a> or email <code class="language-plaintext highlighter-rouge">support@graphql.pro</code>.</p>

<h3 id="checking-for-deferrals">Checking for deferrals</h3>

<p>When a query has any <code class="language-plaintext highlighter-rouge">@defer</code>ed fields, you can check for <code class="language-plaintext highlighter-rouge">context[:defer]</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="n">context</span><span class="p">[</span><span class="ss">:defer</span><span class="p">]</span>
  <span class="c1"># some fields were `@defer`ed</span>
<span class="k">else</span>
  <span class="c1"># normal GraphQL, no `@defer`</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="working-with-deferrals">Working with deferrals</h3>

<p>To handle deferrals, you can enumerate over <code class="language-plaintext highlighter-rouge">context[:defer]</code>, for example:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">context</span><span class="p">[</span><span class="ss">:defer</span><span class="p">].</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">deferral</span><span class="o">|</span>
  <span class="c1"># do something with the `deferral`, eg</span>
  <span class="c1"># stream_to_client(deferral.to_h)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The initial result is <em>also</em> present in the deferrals, so you can treat it just like a patch.</p>

<p>Each deferred patch has a few methods for building a response:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">.to_h</code> returns a hash with <code class="language-plaintext highlighter-rouge">path:</code>, <code class="language-plaintext highlighter-rouge">data:</code>, and/or <code class="language-plaintext highlighter-rouge">errors:</code>. (There is no <code class="language-plaintext highlighter-rouge">path:</code> for the root result.)</li>
  <li><code class="language-plaintext highlighter-rouge">.to_http_multipart(incremental: true)</code> returns a string which works with Apollo client’s <code class="language-plaintext highlighter-rouge">@defer</code> support. (Use <code class="language-plaintext highlighter-rouge">incremental: true</code> to format patches for the forthcoming spec.)</li>
  <li><code class="language-plaintext highlighter-rouge">.path</code> returns the path to this patch in the response</li>
  <li><code class="language-plaintext highlighter-rouge">.data</code> returns successfully-resolved results of the patch</li>
  <li><code class="language-plaintext highlighter-rouge">.errors</code> returns an array of errors, if there were any</li>
</ul>

<p>Calling <code class="language-plaintext highlighter-rouge">.data</code> or <code class="language-plaintext highlighter-rouge">.errors</code> on a deferral will resume GraphQL execution until the patch is complete.</p>

<h3 id="example-rails-with-apollo-client">Example: Rails with Apollo Client</h3>

<p>In this example, a Rails controller will stream HTTP Multipart patches to the client, in Apollo Client’s supported format.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">GraphqlController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># Support `response.stream` below:</span>
  <span class="kp">include</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Live</span>

  <span class="k">def</span> <span class="nf">execute</span>
    <span class="c1"># ...</span>
    <span class="n">result</span> <span class="o">=</span> <span class="no">MySchema</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="ss">variables: </span><span class="n">variables</span><span class="p">,</span> <span class="ss">context: </span><span class="n">context</span><span class="p">,</span> <span class="ss">operation_name: </span><span class="n">operation_name</span><span class="p">)</span>

    <span class="c1"># Check if this is a deferred query:</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">deferred</span> <span class="o">=</span> <span class="n">result</span><span class="p">.</span><span class="nf">context</span><span class="p">[</span><span class="ss">:defer</span><span class="p">])</span>
      <span class="c1"># Required for Rack 2.2+, see https://github.com/rack/rack/issues/1619</span>
      <span class="n">response</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Last-Modified'</span><span class="p">]</span> <span class="o">=</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">.</span><span class="nf">httpdate</span>
      <span class="c1"># Use built-in `stream_http_multipart` with Apollo-Client &amp; ActionController::Live</span>
      <span class="n">deferred</span><span class="p">.</span><span class="nf">stream_http_multipart</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="ss">incremental: </span><span class="kp">true</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="c1"># Return a plain, non-deferred result</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="n">result</span>
    <span class="k">end</span>
  <span class="k">ensure</span>
    <span class="c1"># Always make sure to close the stream</span>
    <span class="n">response</span><span class="p">.</span><span class="nf">stream</span><span class="p">.</span><span class="nf">close</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>You can also investigate a <a href="https://github.com/rmosolgo/graphql_defer_example">full Rails &amp; Apollo-Client demo</a></p>

<h2 id="with-graphql-batch">With GraphQL-Batch</h2>

<p><code class="language-plaintext highlighter-rouge">GraphQL-Batch</code> is a third-party data loading library that wraps GraphQL-Ruby execution. Deferred resolution happens outside the normal execution flow, so to work with GraphQL-Batch, you have to customize <code class="language-plaintext highlighter-rouge">GraphQL::Pro::Defer</code> a bit. Also, you’ll need GraphQL-Pro <code class="language-plaintext highlighter-rouge">v1.24.6</code> or later. Here’s a custom <code class="language-plaintext highlighter-rouge">Defer</code> implementation:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/graphql/directives/defer.rb</span>
<span class="k">module</span> <span class="nn">Directives</span>
  <span class="c1"># Modify the library's `@defer` implementation to work with GraphQL-Batch</span>
  <span class="k">class</span> <span class="nc">Defer</span> <span class="o">&lt;</span> <span class="no">GraphQL</span><span class="o">::</span><span class="no">Pro</span><span class="o">::</span><span class="no">Defer</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">resolve</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
      <span class="c1"># While the query is running, store the batch executor to re-use later</span>
      <span class="n">context</span><span class="p">[</span><span class="ss">:graphql_batch_executor</span><span class="p">]</span> <span class="o">||=</span> <span class="no">GraphQL</span><span class="o">::</span><span class="no">Batch</span><span class="o">::</span><span class="no">Executor</span><span class="p">.</span><span class="nf">current</span>
      <span class="k">super</span>
    <span class="k">end</span>

    <span class="k">class</span> <span class="nc">Deferral</span> <span class="o">&lt;</span> <span class="no">GraphQL</span><span class="o">::</span><span class="no">Pro</span><span class="o">::</span><span class="no">Defer</span><span class="o">::</span><span class="no">Deferral</span>
      <span class="k">def</span> <span class="nf">resolve</span>
        <span class="c1"># Before calling the deferred execution,</span>
        <span class="c1"># set GraphQL-Batch back up:</span>
        <span class="n">prev_executor</span> <span class="o">=</span> <span class="no">GraphQL</span><span class="o">::</span><span class="no">Batch</span><span class="o">::</span><span class="no">Executor</span><span class="p">.</span><span class="nf">current</span>
        <span class="no">GraphQL</span><span class="o">::</span><span class="no">Batch</span><span class="o">::</span><span class="no">Executor</span><span class="p">.</span><span class="nf">current</span> <span class="o">||=</span> <span class="vi">@context</span><span class="p">[</span><span class="ss">:graphql_batch_executor</span><span class="p">]</span>
        <span class="k">super</span>
      <span class="k">ensure</span>
        <span class="c1"># Clean up afterward:</span>
        <span class="no">GraphQL</span><span class="o">::</span><span class="no">Batch</span><span class="o">::</span><span class="no">Executor</span><span class="p">.</span><span class="nf">current</span> <span class="o">=</span> <span class="n">prev_executor</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>And update your schema to use your custom defer implementation:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Use our GraphQL-Batch-compatible defer:</span>
<span class="n">use</span> <span class="no">Directives</span><span class="o">::</span><span class="no">Defer</span>
</code></pre></div></div>
<h2 id="next-steps">Next Steps</h2>

<p>Read about <a href="/defer/usage">client usage</a> of <code class="language-plaintext highlighter-rouge">@defer</code>.</p>

</div>
<p class="guide-footer">
  Suggestion, improvement, or correction?
  <a href="https://github.com/rmosolgo/graphql-ruby/edit/master/guides/defer/setup.md">Edit this file</a> or
  <a href="https://github.com/rmosolgo/graphql-ruby/issues/new?title=Guide: Server Setup">report an issue</a>.
</p>
<script>
  // Find headers with IDs and wrap their text in `<a href=></a>`
  // That way people can easily copy the link.
  var headers = document.querySelectorAll("h1, h2, h3, h4, h5");
  var header, idText, headerLink;
  for (var i = 0; i < headers.length; i++) {
    header = headers[i];
    idText = header.id;
    if (idText) {
      headerLink = document.createElement("a");
      headerLink.href = "#" + idText;
      headerLink.textContent = header.textContent;
      header.textContent = "";
      header.appendChild(headerLink);
    }
  }
  function navigateToSelected(selectElement) {
    var nextPage = selectElement.selectedOptions[0].dataset["target"]
    document.location = nextPage
  }
</script>

    </div>
    <script src="https://cdn.jsdelivr.net/algoliasearch/3/algoliasearchLite.min.js"></script>
    <script src="/js/search.js"></script>
  </body>
</html>
