<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>GraphQL Ruby - Queries ‚Äî Security</title>
    <link rel="stylesheet" href="/graphql-ruby/css/main.css">
    <link rel="icon" href="/graphql-ruby/graphql-ruby-icon.png">
    <meta name="generator">
  </head>
  <body class="hack">
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-19264608-11', 'auto');
      ga('send', 'pageview');
    </script>
    <div class="container">
      <div style="display: flex; justify-content: center;">
<strong style="white-space: pre; line-height: 1.1em; display: inline-block; font-size: 8px;">
    ‚ñÑ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñÑ     ‚ñÑ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà    ‚ñÑ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà    ‚ñÑ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñÑ    ‚ñÑ‚ñà    ‚ñà‚ñÑ    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñÑ    ‚ñÑ‚ñà
   ‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà
   ‚ñà‚ñà‚ñà    ‚ñà‚ñÄ    ‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà
  ‚ñÑ‚ñà‚ñà‚ñà         ‚ñÑ‚ñà‚ñà‚ñà‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñà‚ñà‚ñÄ   ‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà  ‚ñÑ‚ñà‚ñà‚ñà‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñà‚ñà‚ñà‚ñÑ‚ñÑ ‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà
 ‚ñÄ‚ñÄ‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñÑ  ‚ñÄ‚ñÄ‚ñà‚ñà‚ñà‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ   ‚ñÄ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñÄ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñÄ  ‚ñÄ‚ñÄ‚ñà‚ñà‚ñà‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñà‚ñà‚ñà‚ñÄ  ‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà
   ‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà ‚ñÄ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà          ‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà
   ‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà          ‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñÄ ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñå    ‚ñÑ
   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñÄ    ‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà    ‚ñà‚ñÄ   ‚ñÑ‚ñà‚ñà‚ñà‚ñà‚ñÄ        ‚ñà‚ñà‚ñà    ‚ñà‚ñÄ     ‚ñÄ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñÄ‚ñÑ‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñÑ‚ñÑ‚ñà‚ñà
                ‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà                                                      ‚ñÄ
</strong>
      </div>
      <p style="text-align: center;">A GraphQL server implementation for Ruby</p>

      <div class="grid -between">
        <div class="cell -3of12">
          <h3>Guides</h3>
          <ul>
            <li><a href="/graphql-ruby/">Getting Started</a></li>
            <li>
              <strong>Schema</strong>
              <ul>
                <li><a href="/graphql-ruby/schema/types_and_fields">Types and Fields</a></li>
                <li><a href="/graphql-ruby/schema/configuration_options">Configuration Options</a></li>
                <li><a href="/graphql-ruby/schema/code_reuse">Code Reuse</a></li>
                <li><a href="/graphql-ruby/schema/testing">Testing</a></li>
              </ul>
            </li>
            <li>
              <strong>Queries</strong>
              <ul>
                <li><a href="/graphql-ruby/queries/executing_queries">Executing Queries</a></li>
                <li><a href="/graphql-ruby/queries/authorization">Authorization</a></li>
                <li><a href="/graphql-ruby/queries/security">Security</a></li>
                <li><a href="/graphql-ruby/queries/error_handling">Error Handling</a></li>
                <li><a href="/graphql-ruby/queries/phases_of_execution">Phases of Execution</a></li>
              </ul>
            </li>
            <li>
              <strong>Relay</strong>
              <ul>
                <li><a href="/graphql-ruby/relay/object_identification">Object Identification</a></li>
                <li><a href="/graphql-ruby/relay/connections">Connections</a></li>
                <li><a href="/graphql-ruby/relay/mutations">Mutations</a></li>
              </ul>
            </li>
          </ul>
          <h3><a href="http://www.rubydoc.info/github/rmosolgo/graphql-ruby">API Docs</a></h3>
          <h3><a href="https://github.com/rmosolgo/graphql-ruby">Source Code</a></h3>
        </div>
        <div class="cell -9of12">
          <h1 class="guide-header">Queries ‚Äî Security</h1>
          <p>Since a GraphQL endpoint provides arbitrary access to your application, you should employ safeguards to prevent large queries from swamping your system.</p>

<h2 id="limiting-lists-of-items">Limiting lists of items</h2>

<p>Always limit the number of items which can be returned from a list field. For example, use a <code class="highlighter-rouge">limit:</code> argument and make sure it‚Äôs not too big:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">field</span> <span class="ss">:items</span><span class="p">,</span> <span class="n">types</span><span class="p">[</span><span class="no">ItemType</span><span class="p">]</span> <span class="k">do</span>
  <span class="n">argument</span> <span class="ss">:limit</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="no">Int</span><span class="p">,</span> <span class="ss">default_value: </span><span class="mi">20</span>
  <span class="n">resolve</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1"># Cap the number of items at 30</span>
    <span class="n">limit</span> <span class="o">=</span> <span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="ss">:limit</span><span class="p">],</span> <span class="mi">30</span><span class="p">].</span><span class="nf">min</span>
    <span class="n">obj</span><span class="p">.</span><span class="nf">items</span><span class="p">.</span><span class="nf">limit</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>
  <span class="p">}</span>
<span class="k">end</span>
</code></pre>
</div>

<p>This way, you won‚Äôt hit your database for 1000 items!</p>

<h2 id="enforce-a-timeout">Enforce a timeout</h2>

<p>You can apply a timeout to query execution with <code class="highlighter-rouge">TimeoutMiddleware</code>. For example:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="no">MySchema</span><span class="p">.</span><span class="nf">middleware</span> <span class="o">&lt;&lt;</span> <span class="no">GraphQL</span><span class="o">::</span><span class="no">Schema</span><span class="o">::</span><span class="no">TimeoutMiddleware</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">max_seconds: </span><span class="mi">2</span><span class="p">)</span>
</code></pre>
</div>

<p>After <code class="highlighter-rouge">max_seconds</code>, no new fields will be resolved. Instead, errors will be added to the <code class="highlighter-rouge">errors</code> key for fields that weren‚Äôt resolved.</p>

<p><strong>Note</strong> that this does not <em>interrupt</em> field execution. If you‚Äôre making external calls (eg, HTTP requests or database queries), make sure to use a ‚Äúlower level‚Äù timeout for the specific operation.</p>

<p>To log the error, pass a block to the middleware:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="no">MySchema</span><span class="p">.</span><span class="nf">middleware</span> <span class="o">&lt;&lt;</span> <span class="no">GraphQL</span><span class="o">::</span><span class="no">Schema</span><span class="o">::</span><span class="no">TimeoutMiddleware</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">max_seconds: </span><span class="mi">2</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">err</span><span class="p">,</span> <span class="n">query</span><span class="o">|</span>
  <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"GraphQL Timeout: </span><span class="si">#{</span><span class="n">query</span><span class="p">.</span><span class="nf">query_string</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
</div>

<h2 id="prevent-complex-queries">Prevent complex queries</h2>

<p>Fields have a ‚Äúcomplexity‚Äù value which can be configured in their definition. It can be a constant (numeric) value, or a proc. It can be defined as a keyword <em>or</em> inside the configuration block. For example:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="c1"># Constant complexity:</span>
<span class="n">field</span> <span class="ss">:top_score</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="no">Int</span><span class="p">,</span> <span class="ss">complexity: </span><span class="mi">10</span>

<span class="c1"># Dynamic complexity:</span>
<span class="n">field</span> <span class="ss">:top_scorers</span><span class="p">,</span> <span class="n">types</span><span class="p">[</span><span class="no">PlayerType</span><span class="p">]</span> <span class="k">do</span>
  <span class="n">argument</span> <span class="ss">:limit</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="no">Int</span><span class="p">,</span> <span class="ss">default_value: </span><span class="mi">5</span>
  <span class="n">complexity</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">child_complexity</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">ctx</span><span class="p">[</span><span class="ss">:current_user</span><span class="p">].</span><span class="nf">staff?</span>
      <span class="c1"># no limit for staff users</span>
      <span class="mi">0</span>
    <span class="k">else</span>
      <span class="c1"># `child_complexity` is the value for selections</span>
      <span class="c1"># which were made on the items of this list.</span>
      <span class="c1">#</span>
      <span class="c1"># We don't know how many items will be fetched because</span>
      <span class="c1"># we haven't run the query yet, but we can estimate by</span>
      <span class="c1"># using the `limit` argument which we defined above.</span>
      <span class="n">args</span><span class="p">[</span><span class="ss">:limit</span><span class="p">]</span> <span class="o">*</span> <span class="n">child_complexity</span>
    <span class="k">end</span>
  <span class="p">}</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Then, define your <code class="highlighter-rouge">max_complexity</code> at the schema-level:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="no">MySchema</span> <span class="o">=</span> <span class="no">GraphQL</span><span class="o">::</span><span class="no">Schema</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
 <span class="c1"># ...</span>
 <span class="n">max_complexity</span> <span class="mi">100</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Or, at the query-level, which overrides the schema-level setting:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="no">MySchema</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">query_string</span><span class="p">,</span> <span class="ss">max_complexity: </span><span class="mi">100</span><span class="p">)</span>
</code></pre>
</div>

<p>Using <code class="highlighter-rouge">nil</code> will disable the validation:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="c1"># üòß Anything goes!</span>
<span class="no">MySchema</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">query_string</span><span class="p">,</span> <span class="ss">max_complexity: </span><span class="kp">nil</span><span class="p">)</span>
</code></pre>
</div>

<p>To get a feeling for complexity of queries in your system, you can use the <code class="highlighter-rouge">QueryComplexity</code> query reducer. Hook it up to log out values from each query:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">log_query_complexity</span> <span class="o">=</span> <span class="no">GraphQL</span><span class="o">::</span><span class="no">Analysis</span><span class="o">::</span><span class="no">QueryComplexity</span><span class="p">.</span><span class="nf">new</span> <span class="p">{</span> <span class="o">|</span><span class="n">query</span><span class="p">,</span> <span class="n">complexity</span><span class="o">|</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"[GraphQL Query Complexity] </span><span class="si">#{</span><span class="n">complexity</span><span class="si">}</span><span class="s2">  | staff? </span><span class="si">#{</span><span class="n">query</span><span class="p">.</span><span class="nf">context</span><span class="p">[</span><span class="ss">:current_user</span><span class="p">].</span><span class="nf">staff?</span><span class="si">}</span><span class="s2">"</span><span class="p">)}</span>
<span class="no">MySchema</span><span class="p">.</span><span class="nf">query_analyzers</span> <span class="o">&lt;&lt;</span> <span class="n">log_query_complexity</span>
</code></pre>
</div>

<h2 id="prevent-deeply-nested-queries">Prevent deeply-nested queries</h2>

<p>You can also reject queries based on the depth of their nesting. You can define <code class="highlighter-rouge">max_depth</code> at schema-level or query-level:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="c1"># Schema-level:</span>
<span class="no">MySchema</span> <span class="o">=</span> <span class="no">GraphQL</span><span class="o">::</span><span class="no">Schema</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">max_depth</span> <span class="mi">10</span>
<span class="k">end</span>

<span class="c1"># Query-level, which overrides the schema-level setting:</span>
<span class="no">MySchema</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">query_string</span><span class="p">,</span> <span class="ss">max_depth: </span><span class="mi">10</span><span class="p">)</span>
</code></pre>
</div>

<p>You can use <code class="highlighter-rouge">nil</code> to disable the validation:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="c1"># This query won't be validated:</span>
<span class="no">MySchema</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">query_string</span><span class="p">,</span> <span class="ss">max_depth: </span><span class="kp">nil</span><span class="p">)</span>
</code></pre>
</div>

<p>To get a feeling for depth of queries in your system, you can use the <code class="highlighter-rouge">QueryDepth</code> query reducer. Hook it up to log out values from each query:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">log_query_depth</span> <span class="o">=</span> <span class="no">GraphQL</span><span class="o">::</span><span class="no">Analysis</span><span class="o">::</span><span class="no">QueryDepth</span><span class="p">.</span><span class="nf">new</span> <span class="p">{</span> <span class="o">|</span><span class="n">query</span><span class="p">,</span> <span class="n">depth</span><span class="o">|</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"[GraphQL Query Depth] </span><span class="si">#{</span><span class="n">depth</span><span class="si">}</span><span class="s2"> || staff?  </span><span class="si">#{</span><span class="n">query</span><span class="p">.</span><span class="nf">context</span><span class="p">[</span><span class="ss">:current_user</span><span class="p">].</span><span class="nf">staff?</span><span class="si">}</span><span class="s2">"</span><span class="p">)}</span>
<span class="no">MySchema</span><span class="p">.</span><span class="nf">query_analyzers</span> <span class="o">&lt;&lt;</span> <span class="n">log_query_depth</span>
</code></pre>
</div>

<h2 id="only-execute-predefined-queries">Only execute predefined queries</h2>

<p>If you don‚Äôt want to accept arbitrary queries from the ‚Äúoutside world‚Äù, you can cache queries on the server and fetch them in response to specific requests.</p>

<p>For example, you could store parsed <code class="highlighter-rouge">GraphQL::Language::Nodes::Document</code> objects in a cache:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">parsed_document</span> <span class="o">=</span> <span class="no">GraphQL</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">query_string</span><span class="p">)</span>
<span class="n">operation_name</span> <span class="o">=</span> <span class="n">parsed_document</span><span class="p">.</span><span class="nf">definitions</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">name</span>
<span class="no">MyCache</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="n">operation_name</span><span class="p">,</span> <span class="n">parsed_document</span><span class="p">)</span>
</code></pre>
</div>

<p>Then, later, you could fetch the document from storage and use it to run a query:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="c1"># later ...</span>
<span class="n">operation_name</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:operation_name</span><span class="p">]</span>
<span class="n">document</span> <span class="o">=</span> <span class="no">MyCache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">operation_name</span><span class="p">)</span>
<span class="k">if</span> <span class="n">document</span><span class="p">.</span><span class="nf">nil?</span>
  <span class="k">raise</span><span class="p">(</span><span class="s2">"No stored operation called </span><span class="si">#{</span><span class="n">operation_name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="k">else</span>
  <span class="c1"># use `document` instead of a query string:</span>
  <span class="no">MySchema</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="ss">context: </span><span class="p">{</span> <span class="p">.</span><span class="nf">.</span><span class="o">.</span> <span class="p">})</span>
<span class="k">end</span>
</code></pre>
</div>

<p>This way, no unknown queries are evaluated by the server.</p>

        </div>
      </div>
    </div>
  </body>
</html>
