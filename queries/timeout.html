<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
      <title>GraphQL - Timeout</title>
    
    <link href="https://fonts.googleapis.com/css?family=Rubik:300,400,700" rel="stylesheet" />
    <link rel="stylesheet" href="/css/main.css">
    <link rel="icon" href="/graphql-ruby-icon.png">
  </head>
  <body>
    <div class="header">
      <div class="header-container">
        <div class="nav">
          <a href="/" class="img-link">
            <img src="/graphql-ruby.png" alt="GraphQL Ruby Logo" />
          </a>
          <a href="/getting_started">Get Started</a>
          <a href="/guides">Guides</a>
          <a href="/api-doc/2.0.22/">API</a>
          <a href="https://tinyletter.com/graphql-ruby">Newsletter</a>
          <a href="https://github.com/rmosolgo/graphql-ruby">Source Code</a>
          <a href="https://graphql.pro">Upgrade to Pro</a>
          <input
            class="search-input"
            onkeyup="GraphQLRubySearch.run(this)"
            type="text"
            placeholder="Search the docs..."
          />
        </div>
      </div>
      <div class="search-results-container">
        <div id="search-results">
        </div>
      </div>
    </div>
    <div class="container">
      <ul class="breadcrumb">
  <li><a href="/guides">Guides</a></li>
  <li>
    <select class="jump-to-select" onchange="navigateToSelected(this)">
      
        <option  data-target="/schema/definition.html">Schema</option>
      
        <option  selected data-target="/queries/executing_queries.html">Queries</option>
      
        <option  data-target="/type_definitions/objects.html">Type Definitions</option>
      
        <option  data-target="/authorization/overview.html">Authorization</option>
      
        <option  data-target="/fields/introduction.html">Fields</option>
      
        <option  data-target="/mutations/mutation_root.html">Mutations</option>
      
        <option  data-target="/errors/overview.html">Errors</option>
      
        <option  data-target="/pagination/overview.html">Pagination</option>
      
        <option  data-target="/relay/range_add.html">Relay</option>
      
        <option  data-target="/dataloader/overview.html">Dataloader</option>
      
        <option  data-target="/subscriptions/overview.html">Subscriptions</option>
      
        <option  data-target="/pro/home.html">GraphQL Pro</option>
      
        <option  data-target="/operation_store/overview.html">GraphQL Pro - OperationStore</option>
      
        <option  data-target="/defer/overview.html">GraphQL Pro - Defer</option>
      
        <option  data-target="/limiters/overview.html">GraphQL Enterprise - Rate Limiters</option>
      
        <option  data-target="/object_cache/overview.html">GraphQL Enterprise - Object Cache</option>
      
        <option  data-target="/changesets/overview.html">GraphQL Enterprise - Changesets</option>
      
        <option  data-target="/javascript_client/overview.html">JavaScript Client</option>
      
        <option  data-target="/language_tools/visitor.html">Language Tools</option>
      
        <option  data-target="/testing/overview.html">Testing</option>
      
        <option  data-target="/development.html">Other</option>
      
    </select>
  </li>
  <li>
    <select class="jump-to-select" onchange="navigateToSelected(this)">
      
        <option  data-target="/queries/executing_queries.html">Executing Queries</option>
      
        <option  data-target="/queries/ast_analysis.html">Ahead-of-Time AST Analysis</option>
      
        <option  data-target="/queries/phases_of_execution.html">Phases of Execution</option>
      
        <option  data-target="/queries/complexity_and_depth.html">Complexity & Depth</option>
      
        <option  selected data-target="/queries/timeout.html">Timeout</option>
      
        <option  data-target="/queries/multiplex.html">Multiplex</option>
      
        <option  data-target="/queries/lookahead.html">Lookahead</option>
      
        <option  data-target="/queries/tracing.html">Tracing</option>
      
        <option  data-target="/queries/backtrace_annotations.html">Backtrace Annotations</option>
      
        <option  data-target="/queries/response_extensions.html">Response Extensions</option>
      
        <option  data-target="/queries/instrumentation.html">Instrumentation</option>
      
    </select>
  </li>
</ul>



<h1 class="guide-header">Timeout</h1>
<div class="guide-table-of-contents"><div class="table-of-contents">
  <h3 class="contents-header">Contents</h3>
  <ol class='contents-list'><li class='contents-entry'><a href='#custom-error-handling'>Custom Error Handling
</a></li><li class='contents-entry'><a href='#customizing-the-timeout-window'>Customizing the Timeout Window
</a></li><li class='contents-entry'><a href='#validation'>Validation
</a></li></ol>
</div>
</div>
<div class="guide-container">
  <p>You can apply a timeout to query execution with the <code class="language-plaintext highlighter-rouge">GraphQL::Schema::Timeout</code> plugin. For example:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MySchema</span> <span class="o">&lt;</span> <span class="no">GraphQL</span><span class="o">::</span><span class="no">Schema</span>
  <span class="n">use</span> <span class="no">GraphQL</span><span class="o">::</span><span class="no">Schema</span><span class="o">::</span><span class="no">Timeout</span><span class="p">,</span> <span class="ss">max_seconds: </span><span class="mi">2</span>
<span class="k">end</span>
</code></pre></div></div>

<p>After <code class="language-plaintext highlighter-rouge">max_seconds</code>, no new fields will be resolved. Instead, errors will be added to the <code class="language-plaintext highlighter-rouge">errors</code> key for fields that weren’t resolved.</p>

<p><strong>Note</strong> that this <em>does not interrupt</em> field execution (doing so is <a href="https://www.mikeperham.com/2015/05/08/timeout-rubys-most-dangerous-api/">buggy</a>). If you’re making external calls (eg, HTTP requests or database queries), make sure to use a library-specific timeout for that operation (eg, <a href="https://github.com/redis/redis-rb#timeouts">Redis timeout</a>, <a href="https://ruby-doc.org/stdlib-2.4.1/libdoc/net/http/rdoc/Net/HTTP.html">Net::HTTP</a>’s <code class="language-plaintext highlighter-rouge">ssl_timeout</code>, <code class="language-plaintext highlighter-rouge">open_timeout</code>, and <code class="language-plaintext highlighter-rouge">read_timeout</code>).</p>

<h2 id="custom-error-handling">Custom Error Handling</h2>

<p>To log the error, provide a subclass of <code class="language-plaintext highlighter-rouge">GraphQL::Schema::Timeout</code> with an overridden <code class="language-plaintext highlighter-rouge">handle_timeout</code> method:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MyTimeout</span> <span class="o">&lt;</span> <span class="no">GraphQL</span><span class="o">::</span><span class="no">Schema</span><span class="o">::</span><span class="no">Timeout</span>
  <span class="k">def</span> <span class="nf">handle_timeout</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
    <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">warn</span><span class="p">(</span><span class="s2">"GraphQL Timeout: </span><span class="si">#{</span><span class="n">error</span><span class="p">.</span><span class="nf">message</span><span class="si">}</span><span class="s2">: </span><span class="si">#{</span><span class="n">query</span><span class="p">.</span><span class="nf">query_string</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">MySchema</span> <span class="o">&lt;</span> <span class="no">GraphQL</span><span class="o">::</span><span class="no">Schema</span>
  <span class="n">use</span> <span class="no">MyTimeout</span><span class="p">,</span> <span class="ss">max_seconds: </span><span class="mi">2</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="customizing-the-timeout-window">Customizing the Timeout Window</h2>

<p>To dynamically pick a timeout duration (or bypass it), override <a href="/api-doc/2.0.22/GraphQL/Schema/Timeout#max_seconds-instance_method" target="_blank" title="API docs for GraphQL::Schema::Timeout#max_seconds"><code>GraphQL::Schema::Timeout#max_seconds</code></a> in your subclass. To bypass the timeout altogether, <code class="language-plaintext highlighter-rouge">max_seconds</code> can return <code class="language-plaintext highlighter-rouge">false</code>.</p>

<p>For example:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MyTimeout</span> <span class="o">&lt;</span> <span class="no">GraphQL</span><span class="o">::</span><span class="no">Schema</span><span class="o">::</span><span class="no">Timeout</span>
  <span class="c1"># Allow 10s for an incoming mutation, but don't apply any timeout for an admin user.</span>
  <span class="k">def</span> <span class="nf">max_seconds</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">query</span><span class="p">.</span><span class="nf">context</span><span class="p">[</span><span class="ss">:current_user</span><span class="p">]</span><span class="o">&amp;</span><span class="p">.</span><span class="nf">admin?</span>
      <span class="kp">false</span>
    <span class="k">elsif</span> <span class="n">query</span><span class="p">.</span><span class="nf">mutation?</span>
      <span class="mi">10</span>
    <span class="k">else</span>
      <span class="k">super</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># ...</span>

<span class="k">class</span> <span class="nc">MySchema</span> <span class="o">&lt;</span> <span class="no">GraphQL</span><span class="o">::</span><span class="no">Schema</span>
  <span class="n">use</span> <span class="no">MyTimeout</span><span class="p">,</span> <span class="ss">max_seconds: </span><span class="mi">5</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="validation">Validation</h2>

<p>Queries can originate from a user, and may be crafted in a manner to take a long time to validate against the schema.</p>

<p>It is possible to limit how many seconds the static validation rules are allowed to run before returning a validation timeout error. The default is no timeout.</p>

<p>For example:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MySchema</span> <span class="o">&lt;</span> <span class="no">GraphQL</span><span class="o">::</span><span class="no">Schema</span>
  <span class="n">validate_timeout</span> <span class="mi">10</span>
<span class="k">end</span>
</code></pre></div></div>

<p><strong>Note:</strong> This configuration uses Ruby’s built-in <code class="language-plaintext highlighter-rouge">Timeout</code> API, which can interrupt IO calls mid-flight, resulting in <a href="https://www.mikeperham.com/2015/05/08/timeout-rubys-most-dangerous-api/">very weird bugs</a>. None of GraphQL-Ruby’s validators make IO calls but if you want to use this configuration and you have custom static validators that make IO calls, open an issue to discuss implementing this in an IO-safe way.</p>

</div>
<p class="guide-footer">
  Suggestion, improvement, or correction?
  <a href="https://github.com/rmosolgo/graphql-ruby/edit/master/guides/queries/timeout.md">Edit this file</a> or
  <a href="https://github.com/rmosolgo/graphql-ruby/issues/new?title=Guide: Timeout">report an issue</a>.
</p>
<script>
  // Find headers with IDs and wrap their text in `<a href=></a>`
  // That way people can easily copy the link.
  var headers = document.querySelectorAll("h1, h2, h3, h4, h5");
  var header, idText, headerLink;
  for (var i = 0; i < headers.length; i++) {
    header = headers[i];
    idText = header.id;
    if (idText) {
      headerLink = document.createElement("a");
      headerLink.href = "#" + idText;
      headerLink.textContent = header.textContent;
      header.textContent = "";
      header.appendChild(headerLink);
    }
  }
  function navigateToSelected(selectElement) {
    var nextPage = selectElement.selectedOptions[0].dataset["target"]
    document.location = nextPage
  }
</script>

    </div>
    <script src="https://cdn.jsdelivr.net/algoliasearch/3/algoliasearchLite.min.js"></script>
    <script src="/js/search.js"></script>
  </body>
</html>
