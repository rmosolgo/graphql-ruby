<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
      <title>GraphQL - Ably Implementation</title>
    
    <link href="https://fonts.googleapis.com/css?family=Rubik:300,400,700" rel="stylesheet" />
    <link rel="stylesheet" href="/css/main.css">
    <link rel="icon" href="/graphql-ruby-icon.png">
  </head>
  <body>
    <script>
      function detectDarkTheme(toggle) {
        var prefersDarkSchemeSetting = localStorage.getItem("prefersDarkScheme")
        if (prefersDarkSchemeSetting == null) {
          prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)').matches
        } else {
          prefersDarkScheme = prefersDarkSchemeSetting == "true"
        }

        if (toggle) {
          if (prefersDarkScheme) {
            prefersDarkScheme = false
            localStorage.setItem("prefersDarkScheme", "false")
          } else {
            prefersDarkScheme = true
            localStorage.setItem("prefersDarkScheme", "true")
          }
        }

        if (prefersDarkScheme) {
          document.body.classList.add('dark-theme');
          document.querySelectorAll(".graphql-ruby-img").forEach(function(el) {
            el.src = "/graphql-ruby-dark.png"
          })
        } else {
          document.body.classList.remove('dark-theme');
          document.querySelectorAll(".graphql-ruby-img").forEach(function(el) {
            el.src = "/graphql-ruby.png"
          })
        }
      }

      detectDarkTheme(false)
    </script>
    <div class="header">
      <div class="header-container">
        <div class="nav">
          <a href="/" class="img-link">
            <img class="graphql-ruby-img" src="/graphql-ruby.png" alt="GraphQL Ruby Logo" />
          </a>
          <div class="nav-links">
            <a href="/getting_started">Get Started</a>
            <a href="/guides">Guides</a>
            <a href="/api-doc/2.4.15/">API</a>
            <a href="https://buttondown.email/graphql-ruby">Newsletter</a>
            <a href="https://github.com/rmosolgo/graphql-ruby">Source Code</a>
            <a href="https://graphql.pro">Upgrade to Pro</a>
            <input
              class="search-input"
              onkeyup="GraphQLRubySearch.run(this)"
              type="text"
              placeholder="Search the docs..."
            />
            <a href="#" onclick="event.preventDefault(); detectDarkTheme(true)" class="dark-theme-button"></a>
          </div>
        </div>
      </div>
      <div class="search-results-container">
        <div id="search-results">
        </div>
      </div>
    </div>
    <div class="container  fullwidth ">
      <ul class="breadcrumb">
  <li><a href="/guides">Guides</a></li>
  <li>
    <select class="jump-to-select" onchange="navigateToSelected(this)">
      
        <option  data-target="/schema/definition.html">Schema</option>
      
        <option  data-target="/queries/executing_queries.html">Queries</option>
      
        <option  data-target="/type_definitions/objects.html">Type Definitions</option>
      
        <option  data-target="/authorization/overview.html">Authorization</option>
      
        <option  data-target="/fields/introduction.html">Fields</option>
      
        <option  data-target="/mutations/mutation_root.html">Mutations</option>
      
        <option  data-target="/errors/overview.html">Errors</option>
      
        <option  data-target="/pagination/overview.html">Pagination</option>
      
        <option  data-target="/relay/range_add.html">Relay</option>
      
        <option  data-target="/dataloader/overview.html">Dataloader</option>
      
        <option  selected data-target="/subscriptions/overview.html">Subscriptions</option>
      
        <option  data-target="/pro/home.html">GraphQL Pro</option>
      
        <option  data-target="/operation_store/overview.html">GraphQL Pro - OperationStore</option>
      
        <option  data-target="/defer/overview.html">GraphQL Pro - Defer</option>
      
        <option  data-target="/limiters/overview.html">GraphQL Enterprise - Rate Limiters</option>
      
        <option  data-target="/object_cache/overview.html">GraphQL Enterprise - Object Cache</option>
      
        <option  data-target="/changesets/overview.html">GraphQL Enterprise - Changesets</option>
      
        <option  data-target="/javascript_client/overview.html">JavaScript Client</option>
      
        <option  data-target="/language_tools/visitor.html">Language Tools</option>
      
        <option  data-target="/testing/overview.html">Testing</option>
      
        <option  data-target="/development.html">Other</option>
      
    </select>
  </li>
  <li>
    <select class="jump-to-select" onchange="navigateToSelected(this)">
      
        <option  data-target="/subscriptions/overview.html">Overview</option>
      
        <option  data-target="/subscriptions/subscription_classes.html">Subscription Classes</option>
      
        <option  data-target="/subscriptions/subscription_type.html">Subscription Type</option>
      
        <option  data-target="/subscriptions/triggers.html">Triggers</option>
      
        <option  data-target="/subscriptions/broadcast.html">Broadcasts</option>
      
        <option  data-target="/subscriptions/implementation.html">Implementation</option>
      
        <option  data-target="/subscriptions/action_cable_implementation.html">Action Cable Implementation</option>
      
        <option  data-target="/subscriptions/pusher_implementation.html">Pusher Implementation</option>
      
        <option  selected data-target="/subscriptions/ably_implementation.html">Ably Implementation</option>
      
        <option  data-target="/subscriptions/multi_tenant.html">Multi-Tenant</option>
      
    </select>
  </li>
</ul>


  <div class="pro-header">
    <p>
      <strong>‚ö°Ô∏è Pro Feature ‚ö°Ô∏è</strong>
      <span style="font-style: italic;">
        This feature is bundled with <a href="https://graphql.pro">GraphQL-Pro</a>.
      </span>
    </p>
  </div>


<h1 class="guide-header">Ably Implementation</h1>
<div class="guide-table-of-contents"><div class="table-of-contents">
  <h3 class="contents-header">Contents</h3>
  <ol class='contents-list'><li class='contents-entry'><a href='#how-it-works'>How it Works
</a></li><li class='contents-entry'><a href='#ably-setup'>Ably setup
</a></li><li class='contents-entry'><a href='#database-setup'>Database setup
</a></li><li class='contents-entry'><a href='#schema-configuration'>Schema configuration
</a><ol class='contents-list'><li class='contents-entry'><a href='#connection-pool'>Connection Pool
</a></li><li class='contents-entry'><a href='#broadcasts'>Broadcasts
</a></li></ol></li><li class='contents-entry'><a href='#execution-configuration'>Execution configuration
</a></li><li class='contents-entry'><a href='#webhook-configuration'>Webhook configuration
</a><ol class='contents-list'><li class='contents-entry'><a href='#server'>Server
</a></li><li class='contents-entry'><a href='#ably'>Ably
</a></li></ol></li><li class='contents-entry'><a href='#authorization'>Authorization
</a></li><li class='contents-entry'><a href='#encryption'>Encryption
</a></li><li class='contents-entry'><a href='#serializing-context'>Serializing Context
</a></li><li class='contents-entry'><a href='#dashboard'>Dashboard
</a></li><li class='contents-entry'><a href='#development-tips'>Development Tips
</a><ol class='contents-list'><li class='contents-entry'><a href='#clear-subscription-data'>Clear subscription data
</a></li><li class='contents-entry'><a href='#developing-with-webhooks'>Developing with webhooks
</a></li></ol></li><li class='contents-entry'><a href='#client-configuration'>Client configuration
</a></li></ol>
</div>
</div>
<div class="guide-container">
  <p><a href="https://graphql.pro">GraphQL Pro</a> includes a subscription system based on <a href="https://redis.io">Redis</a> and <a href="https://ably.io">Ably</a> which works with any Ruby web framework.</p>

<p>After creating an app on Ably, you can hook it up to your GraphQL schema.</p>

<h2 id="how-it-works">How it Works</h2>

<p>This subscription implementation uses a hybrid approach:</p>

<ul>
  <li><strong>Your app</strong> takes GraphQL queries an runs them</li>
  <li><strong>Redis</strong> stores subscription data for later updates</li>
  <li><strong>Ably</strong> sends updates to subscribed clients</li>
</ul>

<p>So, the lifecycle goes like this:</p>

<ul>
  <li>A <code class="language-plaintext highlighter-rouge">subscription</code> query is sent by HTTP Post to your server (just like a <code class="language-plaintext highlighter-rouge">query</code> or <code class="language-plaintext highlighter-rouge">mutation</code>)</li>
  <li>The response contains an Ably channel ID (as an HTTP header) which the client may subscribe to</li>
  <li>The client opens that Ably channel</li>
  <li>When the server triggers updates, they‚Äôre delivered over the Ably channel</li>
  <li>When the client unsubscribes, the server receives a webhook and responds by removing its subscription data</li>
</ul>

<p>Here‚Äôs another look:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1. Subscription is created in your app

          HTTP POST
        .----------&gt;   write to Redis
      üì±            ‚öôÔ∏è -----&gt; üíæ
        &lt;---------'
        X-Subscription-ID: 1234


2. Client opens a connection to Ably

          websocket
      üì± &lt;---------&gt; ‚òÅÔ∏è


3. The app sends updates via Ably

      ‚öôÔ∏è ---------&gt; ‚òÅÔ∏è ------&gt; üì±
        POST           update
      (via gem)   (via websocket)


4. When the client unsubscribes, Ably notifies the app

          webhook
      ‚öôÔ∏è &lt;-------- ‚òÅÔ∏è  (disconnect) üì±
</code></pre></div></div>

<p>By using this configuration, you can use GraphQL subscriptions without hosting a push server yourself!</p>

<h2 id="ably-setup">Ably setup</h2>
<p>Add <code class="language-plaintext highlighter-rouge">ably-rest</code> to your <code class="language-plaintext highlighter-rouge">Gemfile</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gem</span> <span class="s1">'ably-rest'</span>
</code></pre></div></div>

<p>and <code class="language-plaintext highlighter-rouge">bundle install</code>.</p>

<h2 id="database-setup">Database setup</h2>

<p>Subscriptions require a <em>persistent</em> Redis database, configured with:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>maxmemory-policy noeviction
<span class="c"># optional, more durable persistence:</span>
appendonly <span class="nb">yes</span>
</code></pre></div></div>

<p>Otherwise, Redis will drop data that doesn‚Äôt fit in memory (read more in <a href="https://redis.io/topics/persistence">‚ÄúRedis persistence‚Äù</a>).</p>

<p>If you‚Äôre already using Redis in your application, see <a href="https://www.mikeperham.com/2015/09/24/storing-data-with-redis/">‚ÄúStoring Data in Redis‚Äù</a> for options to isolate data and tune your configuration.</p>

<h2 id="schema-configuration">Schema configuration</h2>

<p>Add <code class="language-plaintext highlighter-rouge">redis</code> to your <code class="language-plaintext highlighter-rouge">Gemfile</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gem</span> <span class="s1">'redis'</span>
</code></pre></div></div>

<p>and <code class="language-plaintext highlighter-rouge">bundle install</code>. Then create a Redis instance:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># for example, in an initializer:</span>
<span class="vg">$graphql_subscriptions_redis</span> <span class="o">=</span> <span class="no">Redis</span><span class="p">.</span><span class="nf">new</span> <span class="c1"># default connection</span>
</code></pre></div></div>

<p>Then, that Redis client is passed to the Subscription configuration:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MySchema</span> <span class="o">&lt;</span> <span class="no">GraphQL</span><span class="o">::</span><span class="no">Schema</span>
  <span class="n">use</span> <span class="no">GraphQL</span><span class="o">::</span><span class="no">Pro</span><span class="o">::</span><span class="no">AblySubscriptions</span><span class="p">,</span>
    <span class="ss">redis: </span><span class="vg">$graphql_subscriptions_redis</span><span class="p">,</span>
    <span class="ss">ably: </span><span class="no">Ably</span><span class="o">::</span><span class="no">Rest</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">key: </span><span class="no">ABLY_API_KEY</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>That connection will be used for managing subscription state. All writes to Redis are prefixed with <code class="language-plaintext highlighter-rouge">graphql:sub:</code>.</p>

<p>There are also two configurations for managing persistence:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">stale_ttl_s:</code> expires subscription data after the given number of seconds without any update. After <code class="language-plaintext highlighter-rouge">stale_ttl_s</code> has passed, the data will expire from Redis. Each time a subscription receives an update, its TTL is refreshed. (Generally, this isn‚Äôt required because the backend is built to clean itself up. But, if you find that Redis is collecting stale queries, you can set them to expire after some very long time as a safeguard.)</li>
  <li><code class="language-plaintext highlighter-rouge">cleanup_delay_s:</code> (default: <code class="language-plaintext highlighter-rouge">5</code>) prevents deleting a subscription during those first seconds after it‚Äôs created. Usually, a longer delay isn‚Äôt necessary, but if you observe latency between the subscription‚Äôs initial response and the client‚Äôs subscription to the delivery channel, you can set this configuration to account for it.</li>
</ul>

<h3 id="connection-pool">Connection Pool</h3>

<p>For better performance reading and writing to Redis, you can pass a <code class="language-plaintext highlighter-rouge">connection_pool:</code> instead of <code class="language-plaintext highlighter-rouge">redis:</code>, using the <a href=""><code class="language-plaintext highlighter-rouge">connection_pool</code> gem</a>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">use</span> <span class="no">GraphQL</span><span class="o">::</span><span class="no">Pro</span><span class="o">::</span><span class="no">AblySubscriptions</span><span class="p">,</span>
    <span class="ss">connection_pool: </span><span class="no">ConnectionPool</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">size: </span><span class="mi">5</span><span class="p">,</span> <span class="ss">timeout: </span><span class="mi">5</span><span class="p">)</span> <span class="p">{</span> <span class="no">Redis</span><span class="p">.</span><span class="nf">new</span> <span class="p">},</span>
    <span class="ss">ably: </span><span class="no">Ably</span><span class="o">::</span><span class="no">Rest</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">key: </span><span class="no">ABLY_API_KEY</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="broadcasts">Broadcasts</h3>

<p>If you set up <a href="/subscriptions/broadcast">Broadcasts</a>, then you can update many clients over a single Ably channel.</p>

<p>Broadcast channels have stable, predictable IDs. To prevent unauthorized clients from ‚Äúlistening in,‚Äù use <a href="#authorization">token authorization</a> for transport. Broadcasts channels use the namespace <code class="language-plaintext highlighter-rouge">gqlbdcst:</code>, so you can provide capabilities to receive them using <code class="language-plaintext highlighter-rouge">"gqlbdcst:*" =&gt; [ ... ]</code> in your authorization code. (If you‚Äôre using <a href="#encryption">encryption</a>, the prefix will be <code class="language-plaintext highlighter-rouge">ablyencr-gqlbdcst:</code> instead.)</p>

<h2 id="execution-configuration">Execution configuration</h2>

<p>During execution, GraphQL will assign a <code class="language-plaintext highlighter-rouge">subscription_id</code> to the <code class="language-plaintext highlighter-rouge">context</code> hash. The client will use that ID to listen for updates, so you must return the <code class="language-plaintext highlighter-rouge">subscription_id</code> in the response headers.</p>

<p>Return <code class="language-plaintext highlighter-rouge">result.context[:subscription_id]</code> as the <code class="language-plaintext highlighter-rouge">X-Subscription-ID</code> header. For example:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">result</span> <span class="o">=</span> <span class="no">MySchema</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="c1"># For subscriptions, return the subscription_id as a header</span>
<span class="k">if</span> <span class="n">result</span><span class="p">.</span><span class="nf">subscription?</span>
  <span class="n">response</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s2">"X-Subscription-ID"</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">.</span><span class="nf">context</span><span class="p">[</span><span class="ss">:subscription_id</span><span class="p">]</span>
<span class="k">end</span>
<span class="n">render</span> <span class="ss">json: </span><span class="n">result</span>
</code></pre></div></div>

<p>This way, the client can use that ID as a Ably channel.</p>

<p>For <strong>CORS requests</strong>, you need a special header so that clients can read the custom header:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="n">result</span><span class="p">.</span><span class="nf">subscription?</span>
  <span class="n">response</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s2">"X-Subscription-ID"</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">.</span><span class="nf">context</span><span class="p">[</span><span class="ss">:subscription_id</span><span class="p">]</span>
  <span class="c1"># Required for CORS requests:</span>
  <span class="n">response</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s2">"Access-Control-Expose-Headers"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"X-Subscription-ID"</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Read more here: <a href="https://www.html5rocks.com/en/tutorials/cors/">‚ÄúUsing CORS‚Äù</a>.</p>

<h2 id="webhook-configuration">Webhook configuration</h2>

<p>Your server needs to receive webhooks from Ably when clients disconnect. This keeps your local subscription database in sync with Ably.</p>

<h3 id="server">Server</h3>

<p><em>Note: if you‚Äôre setting up in a development environment you should follow the <a href="#Developing-with-webhooks">Developing with webhooks</a> section first</em></p>

<p>Mount the Rack app for handling webhooks from Ably. For example, on Rails:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/routes.rb</span>

<span class="c1"># Include GraphQL::Pro's routing extensions:</span>
<span class="n">using</span> <span class="no">GraphQL</span><span class="o">::</span><span class="no">Pro</span><span class="o">::</span><span class="no">Routes</span>

<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="c1"># Handle webhooks for subscriptions:</span>
  <span class="n">mount</span> <span class="no">MySchema</span><span class="p">.</span><span class="nf">ably_webhooks_client</span><span class="p">,</span> <span class="ss">at: </span><span class="s2">"/ably_webhooks"</span>
<span class="k">end</span>
</code></pre></div></div>

<p><strong>Alternatively</strong>, you can configure the routes to load your schema lazily, during the first request:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Provide the fully-qualified class name of your schema:</span>
<span class="n">lazy_routes</span> <span class="o">=</span> <span class="no">GraphQL</span><span class="o">::</span><span class="no">Pro</span><span class="o">::</span><span class="no">Routes</span><span class="o">::</span><span class="no">Lazy</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"MySchema"</span><span class="p">)</span>
<span class="n">mount</span> <span class="n">lazy_routes</span><span class="p">.</span><span class="nf">ably_webhooks_client</span><span class="p">,</span> <span class="ss">at: </span><span class="s2">"/ably_webhooks"</span>
</code></pre></div></div>

<h3 id="ably">Ably</h3>

<ol>
  <li>Go to the Ably dashboard</li>
  <li>Click on your application</li>
  <li>Select the <strong>‚ÄúIntegrations‚Äù</strong> tab</li>
  <li>Click on the <strong>‚Äù+ New Integration Rule‚Äù</strong> button</li>
  <li>Click on the ‚ÄúChoose‚Äù button for <strong>‚ÄúWebhook‚Äù</strong></li>
  <li>Click on the ‚ÄúChoose‚Äù button for <strong>‚ÄúWebhook‚Äù</strong> (again)</li>
  <li>Enter <strong>your URL (including the webhooks path from above)</strong> in the URL field.</li>
  <li>Select <strong>‚ÄúBatch request‚Äù</strong> for ‚ÄúRequest Mode‚Äù</li>
  <li>Under ‚ÄúSource‚Äù, select <strong>‚ÄúPresence‚Äù</strong></li>
  <li>Under ‚ÄúSign with key‚Äù, select the API Key prefix that matches the prefix of the <code class="language-plaintext highlighter-rouge">ABLY_API_KEY</code> you provided</li>
  <li>Click <strong>‚ÄúCreate‚Äù</strong></li>
</ol>

<h2 id="authorization">Authorization</h2>

<p>You can use Ably‚Äôs <a href="https://www.ably.io/documentation/realtime/authentication#token-authentication">token authentication</a> by implementing an endpoint in your app, for example:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">AblyController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
  <span class="k">def</span> <span class="nf">auth</span>
    <span class="n">render</span> <span class="ss">status: </span><span class="mi">201</span><span class="p">,</span> <span class="ss">json: </span><span class="n">ably_rest_client</span><span class="p">.</span><span class="nf">auth</span><span class="p">.</span><span class="nf">create_token_request</span><span class="p">(</span>
      <span class="ss">capability: </span><span class="p">{</span> <span class="s1">'*'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'presence'</span><span class="p">,</span> <span class="s1">'subscribe'</span><span class="p">]</span> <span class="p">},</span>
      <span class="ss">client_id: </span><span class="s1">'graphql-subscriber'</span><span class="p">,</span>
    <span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p><a href="https://www.ably.io/tutorials/webhook-chuck-norris#tutorial-step-4">Ably‚Äôs tutorial</a> also demonstrates some of the setup for this.</p>

<h2 id="encryption">Encryption</h2>

<p>You can use Ably‚Äôs <a href="https://www.ably.io/documentation/realtime/encryption">end-to-end encryption</a> with GraphQL subscriptions. To enable it, add <code class="language-plaintext highlighter-rouge">cipher_base:</code> to your setup:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">use</span> <span class="no">GraphQL</span><span class="o">::</span><span class="no">Pro</span><span class="o">::</span><span class="no">AblySubscriptions</span><span class="p">,</span>
    <span class="ss">redis: </span><span class="vg">$graphql_subscriptions_redis</span><span class="p">,</span>
    <span class="ss">ably: </span><span class="no">Ably</span><span class="o">::</span><span class="no">Rest</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">key: </span><span class="no">ABLY_API_KEY</span><span class="p">),</span>
    <span class="c1"># Add `cipher_base:` to enable end-to-end encryption</span>
    <span class="ss">cipher_base: </span><span class="s2">"ff16381ae2f2b6c6de6ff696226009f3"</span>
</code></pre></div></div>

<p>(Any random string will do, eg <code class="language-plaintext highlighter-rouge">ruby -e "require 'securerandom'; puts SecureRandom.hex"</code>.)</p>

<p>Also, return a header to client so that it can decrypt subscription updates. The key is put in <code class="language-plaintext highlighter-rouge">context[:ably_cipher_base64]</code>, and <code class="language-plaintext highlighter-rouge">graphql-ruby-client</code> expects to find it in the <code class="language-plaintext highlighter-rouge">X-Subscription-Key</code> header:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">result</span> <span class="o">=</span> <span class="no">MySchema</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="c1"># For subscriptions, return the subscription_id as a header</span>
<span class="k">if</span> <span class="n">result</span><span class="p">.</span><span class="nf">subscription?</span>
  <span class="n">response</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s2">"X-Subscription-ID"</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">.</span><span class="nf">context</span><span class="p">[</span><span class="ss">:subscription_id</span><span class="p">]</span>
  <span class="c1"># Also return the encryption key so that clients</span>
  <span class="c1"># can decode subscription updates</span>
  <span class="n">response</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s2">"X-Subscription-Key"</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">.</span><span class="nf">context</span><span class="p">[</span><span class="ss">:ably_cipher_base64</span><span class="p">]</span>
<span class="k">end</span>
</code></pre></div></div>

<p>(Also, if you‚Äôre using CORS requests, update <code class="language-plaintext highlighter-rouge">Access-Control-Expose-Headers</code> to include <code class="language-plaintext highlighter-rouge">X-Subscription-Key</code>)</p>

<p>With this setup,</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">GraphQL::Pro::AblySubscriptions</code> will generate per-subscription keys (using <code class="language-plaintext highlighter-rouge">cipher_base</code> and the subscription ID) and use them to encrypt Ably payloads</li>
  <li>Those keys will be returned to clients in <code class="language-plaintext highlighter-rouge">X-Subscription-Key</code></li>
  <li>Clients will use those keys to decrypt incoming messages</li>
</ul>

<p><strong>Backwards compatibility:</strong> <code class="language-plaintext highlighter-rouge">GraphQL::Pro::AblySubscriptions</code> will only encrypt payloads whose <code class="language-plaintext highlighter-rouge">query.context[:ably_cipher_base64]</code> is present. Any subscriptions created <em>before</em> <code class="language-plaintext highlighter-rouge">cipher_base:</code> was added to the setup will <em>not</em> be encrypted. (There was no key to encrypt them, and clients don‚Äôt have a key to <em>decrypt</em> them!)</p>

<h2 id="serializing-context">Serializing Context</h2>

<p>Since subscription state is stored in the database, then reloaded for pushing updates, you have to serialize and reload your query <code class="language-plaintext highlighter-rouge">context</code>.</p>

<p>By default, this is done with <a href="/api-doc/2.4.15/GraphQL/Subscriptions/Serialize" target="_blank" title="API docs for GraphQL::Subscriptions::Serialize"><code>GraphQL::Subscriptions::Serialize</code></a>‚Äôs <code class="language-plaintext highlighter-rouge">dump</code> and <code class="language-plaintext highlighter-rouge">load</code> methods, but you can provide custom implementations as well. To customize the serialization logic, create a subclass of <code class="language-plaintext highlighter-rouge">GraphQL::Pro::AblySubscriptions</code> and override <code class="language-plaintext highlighter-rouge">#dump_context(ctx)</code> and <code class="language-plaintext highlighter-rouge">#load_context(ctx_string)</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CustomSubscriptions</span> <span class="o">&lt;</span> <span class="no">GraphQL</span><span class="o">::</span><span class="no">Pro</span><span class="o">::</span><span class="no">AblySubscriptions</span>
  <span class="k">def</span> <span class="nf">dump_context</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
    <span class="n">context_hash</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">.</span><span class="nf">to_h</span>
    <span class="c1"># somehow convert this hash to a string, return the string</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">load_context</span><span class="p">(</span><span class="n">ctx_string</span><span class="p">)</span>
    <span class="c1"># Given the string from the DB, create a new hash</span>
    <span class="c1"># to use as `context:`</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Then, use your <em>custom</em> subscriptions class instead of the built-in one for your schema:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MySchema</span> <span class="o">&lt;</span> <span class="no">GraphQL</span><span class="o">::</span><span class="no">Schema</span>
  <span class="c1"># Use custom subscriptions instead of GraphQL::Pro::AblySubscriptions</span>
  <span class="c1"># to get custom serialization logic</span>
  <span class="n">use</span> <span class="no">CustomSubscriptions</span><span class="p">,</span> <span class="o">...</span>
<span class="k">end</span>
</code></pre></div></div>

<p>That gives you fine-grained control of context reloading.</p>

<h2 id="dashboard">Dashboard</h2>

<p>You can monitor subscription state in the <a href="/pro/dashboard">GraphQL-Pro Dashboard</a>:</p>

<p><a href="/subscriptions/redis_dashboard_1.png" target="_blank" class="img-link">
  <img src="/subscriptions/redis_dashboard_1.png" title="Redis Subscription Dashboard" alt="Redis Subscription Dashboard" />
</a></p>

<p><a href="/subscriptions/redis_dashboard_2.png" target="_blank" class="img-link">
  <img src="/subscriptions/redis_dashboard_2.png" title="Redis Subscription Detail" alt="Redis Subscription Detail" />
</a></p>

<h2 id="development-tips">Development Tips</h2>

<h4 id="clear-subscription-data">Clear subscription data</h4>

<p>At any time, you can reset your subscription database with the <strong>‚ÄúReset‚Äù</strong> button in the <a href="/pro/dashboard">GraphQL-Pro Dashboard</a>, or in Ruby:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Wipe all subscription data from the DB:</span>
<span class="no">MySchema</span><span class="p">.</span><span class="nf">subscriptions</span><span class="p">.</span><span class="nf">clear</span>
</code></pre></div></div>

<h4 id="developing-with-webhooks">Developing with webhooks</h4>

<p>To receive webhooks in development, you can <a href="https://www.ably.io/tutorials/webhook-chuck-norris">use ngrok</a>. It gives you a public URL which you can setup with Ably, then any hooks delivered to that URL will be forwarded to your development environment.</p>

<h2 id="client-configuration">Client configuration</h2>

<p>Install the <a href="https://github.com/ably/ably-js">Ably JS client</a> then see docs for:</p>

<ul>
  <li><a href="/javascript_client/apollo_subscriptions">Apollo Client</a></li>
  <li><a href="/javascript_client/relay_subscriptions">Relay Modern</a>.</li>
  <li><a href="/javascript_client/graphiql_subscriptions">GraphiQL</a></li>
</ul>

</div>
<p class="guide-footer">
  Suggestion, improvement, or correction?
  <a href="https://github.com/rmosolgo/graphql-ruby/edit/master/guides/subscriptions/ably_implementation.md">Edit this file</a> or
  <a href="https://github.com/rmosolgo/graphql-ruby/issues/new?title=Guide: Ably Implementation">report an issue</a>.
</p>
<script>
  // Find headers with IDs and wrap their text in `<a href=></a>`
  // That way people can easily copy the link.
  var headers = document.querySelectorAll("h1, h2, h3, h4, h5");
  var header, idText, headerLink;
  for (var i = 0; i < headers.length; i++) {
    header = headers[i];
    idText = header.id;
    if (idText) {
      headerLink = document.createElement("a");
      headerLink.href = "#" + idText;
      headerLink.textContent = header.textContent;
      header.textContent = "";
      header.appendChild(headerLink);
    }
  }
  function navigateToSelected(selectElement) {
    var nextPage = selectElement.selectedOptions[0].dataset["target"]
    document.location = nextPage
  }
</script>

    </div>
    <script src="https://cdn.jsdelivr.net/algoliasearch/3/algoliasearchLite.min.js"></script>
    <script src="/js/search.js"></script>
    <script>
      detectDarkTheme(false) // do it again to update the images
    </script>
  </body>
</html>
